<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…éŠè¨ˆç•« V2 | ç¶“å…¸ç©©å®šç‰ˆ</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif; background-color: #F3F4F6; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        #map-container { z-index: 1; }
        .gps-pulse {
            width: 14px; height: 14px; border: 2px solid #fff; border-radius: 50%;
            background-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in-up 0.4s ease-out forwards; }
        /* ç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
        .sync-status { position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-size: 12px; padding: 6px 12px; border-radius: 20px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; items-center; gap: 6px; font-weight: bold; transition: all 0.3s; }
        .sync-saving { color: #f59e0b; }
        .sync-saved { color: #10b981; }
        .sync-error { color: #ef4444; }
        .sync-local { color: #6366f1; } 

        /* æ‹–æ›³ä¸­çš„æ¨£å¼ */
        .sortable-ghost { opacity: 0.4; background: #f0f9ff; border: 2px dashed #3b82f6; }
        .drag-handle { touch-action: none; cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        
        /* å´é‚Šæ¬„å‹•ç•« */
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative sm:rounded-xl sm:my-4 sm:h-[95vh] sm:border-4 sm:border-slate-100">

        <!-- ç‹€æ…‹æŒ‡ç¤ºç‡ˆ -->
        <div v-if="syncStatus" class="sync-status" :class="syncStatusClass">
            <i class="ph-bold" :class="syncStatusIcon"></i> {{ syncStatus }}
        </div>

        <!-- Header -->
        <header class="bg-teal-600 text-white shrink-0 z-20 shadow-md">
            <div class="p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <!-- å´é‚Šæ¬„é¸å–®æŒ‰éˆ• -->
                    <button @click="showTripMenu = true" class="text-teal-100 hover:text-white transition">
                        <i class="ph-bold ph-list text-2xl"></i>
                    </button>
                    <div class="overflow-hidden">
                        <h1 class="text-xl font-bold tracking-wide flex items-center gap-2 truncate">
                            {{ setup.destination || 'æ—…éŠè¨ˆç•«' }} <i class="ph-fill ph-airplane-tilt text-sm opacity-70"></i>
                        </h1>
                        <!-- é¡¯ç¤ºç›®å‰æ¨¡å¼ -->
                        <div class="text-[10px] flex items-center gap-1 opacity-80">
                            <i class="ph-fill" :class="tripId ? 'ph-cloud' : 'ph-floppy-disk'"></i>
                            {{ tripId ? 'é›²ç«¯å…±ç”¨æ¨¡å¼' : 'æœ¬æ©Ÿæ¨¡å¼' }}
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <button @click="showSettingsModal = true" class="text-teal-100 hover:text-white hover:bg-teal-500/30 p-2 rounded-full transition">
                        <i class="ph-bold ph-gear text-xl"></i>
                    </button>

                    <button @click="copyShareLink" class="text-teal-100 hover:text-white hover:bg-teal-500/30 p-2 rounded-full transition">
                        <i class="ph-bold ph-share-network text-xl"></i>
                    </button>

                    <button @click="viewMode = 'translate'" 
                            :class="viewMode === 'translate' ? 'bg-white text-teal-700 shadow-sm' : 'bg-teal-500/30 text-teal-200 hover:bg-teal-500/50'"
                            class="p-2.5 rounded-xl transition-all h-11 w-11 flex items-center justify-center border border-teal-500/30">
                        <i class="ph-bold ph-translate text-xl"></i>
                    </button>

                    <div class="flex bg-teal-800/50 p-1 rounded-lg">
                        <button @click="viewMode = 'plan'" :class="viewMode === 'plan' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200'" class="p-2 rounded-md transition-all relative">
                            <i class="ph-bold ph-calendar-check text-lg"></i>
                        </button>
                        <button @click="viewMode = 'ticket'" :class="viewMode === 'ticket' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200'" class="p-2 rounded-md transition-all relative">
                            <i class="ph-bold ph-ticket text-lg"></i>
                        </button>
                        <button @click="viewMode = 'money'" :class="viewMode === 'money' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200'" class="p-2 rounded-md transition-all relative">
                            <i class="ph-bold ph-currency-dollar text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex overflow-x-auto hide-scroll px-2 pb-3 space-x-3 snap-x">
                <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index" class="snap-center shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-xl cursor-pointer transition-all border-2" :class="currentDayIdx === index ? 'bg-white text-teal-600 border-white shadow-lg scale-105' : 'bg-teal-500/50 text-teal-100 border-transparent hover:bg-teal-500'">
                    <span class="text-[10px] font-bold opacity-90 mb-0.5">{{ day.shortDate || '--/--' }} ({{ getDayName(day.fullDate) }})</span>
                    <span class="text-lg font-bold leading-none">D{{ index + 1 }}</span>
                </div>
                <button @click="addDay" class="shrink-0 w-12 h-16 rounded-xl flex items-center justify-center border-2 border-teal-400 border-dashed text-teal-200 hover:text-white hover:border-white transition"><i class="ph-bold ph-plus"></i></button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll">
            
            <!-- è¡Œç¨‹è¡¨ (Plan View) -->
            <transition name="fade" mode="out-in">
                <div v-if="viewMode === 'plan'" class="p-4 pb-24">
                    <!-- é ‚éƒ¨æ—¥æœŸèˆ‡å¤©æ°£å€ -->
                    <div class="bg-white p-4 rounded-2xl shadow-sm mb-4 border border-slate-100 flex justify-between items-start">
                        <div class="flex-1 relative pt-0.5">
                            <input type="date" :value="currentDay.fullDate" @change="updateDate($event, currentDay)" class="absolute top-0 left-0 w-40 h-8 opacity-0 z-20 cursor-pointer">
                            <input v-model="currentDay.date" class="text-xl font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0 w-full relative z-10 pointer-events-none" placeholder="Day 1 (é»æ“Šè¨­å®š)">
                            <input v-model="currentDay.title" class="text-sm text-slate-500 bg-transparent border-b border-dashed border-slate-300 focus:border-teal-500 focus:outline-none w-full mt-1" placeholder="è¼¸å…¥ç•¶æ—¥ä¸»é¡Œ">
                        </div>
                        <div class="flex flex-col items-end pl-2">
                            <div v-if="weatherDisplay" class="text-right">
                                <div class="flex items-center justify-end gap-1 text-indigo-600"><i :class="['ph-duotone', weatherDisplay.icon, 'text-2xl']"></i><span class="text-xl font-bold font-mono">{{ weatherDisplay.temp }}</span></div>
                                <div class="text-[10px] text-slate-400 mt-0.5">{{ weatherDisplay.label }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- èˆªç­å¡ç‰‡ -->
                    <div class="mb-6">
                        <div v-if="currentDay.flight && (currentDay.flight.number || currentDay.flight.startTime)" class="relative bg-gradient-to-r from-blue-600 to-teal-500 rounded-2xl text-white shadow-lg p-4">
                            <button @click="toggleFlightCard" class="absolute top-2 right-2 hover:bg-white/20 rounded-full p-1"><i class="ph-bold ph-x"></i></button>
                            <div class="flex justify-between items-center text-center">
                                <div><div class="text-2xl font-mono font-black">{{ currentDay.flight.startTime }}</div><div class="text-xs opacity-70">{{ currentDay.flight.startAirport }}</div></div>
                                <div><i class="ph-fill ph-airplane rotate-90 text-2xl"></i><div class="text-[10px] mt-1 opacity-70">{{ currentDay.flight.number }}</div></div>
                                <div><div class="text-2xl font-mono font-black">{{ currentDay.flight.endTime }}</div><div class="text-xs opacity-70">{{ currentDay.flight.endAirport }}</div></div>
                            </div>
                        </div>
                        <button v-else @click="toggleFlightCard" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 hover:border-teal-400 hover:text-teal-500 font-bold text-sm">æ–°å¢ç•¶æ—¥èˆªç­è³‡è¨Š</button>
                    </div>

                    <!-- è¡Œç¨‹åˆ—è¡¨ (Sortable) -->
                    <div ref="itineraryList" :key="currentDayIdx" class="space-y-4 pl-4 border-l-2 border-teal-100 pb-8">
                        <div v-for="(item, idx) in currentDay.items" :key="item.id" class="relative group bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                            <div class="absolute -left-[23px] top-3 w-3 h-3 rounded-full border-2 border-white shadow-sm" :class="getDotColor(item.type)"></div>
                            <div class="flex gap-3">
                                <div class="drag-handle text-slate-300 cursor-grab py-2"><i class="ph-bold ph-dots-six-vertical"></i></div>
                                <div class="flex-1">
                                    <div class="flex gap-2 mb-2">
                                        <div class="w-16 shrink-0 relative group/time cursor-pointer rounded bg-slate-50 border border-slate-200 text-center py-1">
                                            <div class="text-[10px] text-slate-400">{{ getTimePeriod(item.time) }}</div>
                                            <div class="font-bold text-slate-700">{{ item.time || '--:--' }}</div>
                                            <input v-model="item.time" type="time" class="absolute inset-0 opacity-0 cursor-pointer" @click="$event.target.showPicker()">
                                        </div>
                                        <div class="flex-1">
                                            <input v-model="item.activity" class="w-full font-bold bg-transparent border-none p-0 focus:ring-0" placeholder="è¡Œç¨‹åç¨±...">
                                            <div class="flex items-center gap-1 mt-1"><i class="ph-fill ph-map-pin text-teal-400 text-xs"></i><input v-model="item.location" class="flex-1 text-xs text-slate-500 bg-transparent border-none p-0" placeholder="åœ°é»..."></div>
                                        </div>
                                    </div>
                                    <textarea v-model="item.note" class="auto-resize-textarea w-full text-xs bg-slate-50 rounded p-2 border-none resize-none min-h-[30px]" placeholder="å‚™è¨»..." rows="1" @input="adjustHeight($event.target)"></textarea>
                                    
                                    <!-- Actions -->
                                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-50">
                                        <div class="flex gap-2">
                                            <a :href="getGoogleMapLink(item.location)" target="_blank" class="text-teal-500 bg-teal-50 p-1.5 rounded-lg text-xs"><i class="ph-bold ph-map-pin"></i></a>
                                            <a v-if="isKoreaTrip" :href="getNaverMapLink(item.location)" target="_blank" class="text-green-500 bg-green-50 p-1.5 rounded-lg text-xs font-bold">N</a>
                                            <button v-if="item.location" @click="askAiAboutPlace(item)" class="text-purple-500 bg-purple-50 p-1.5 rounded-lg text-xs"><i v-if="loadingNoteIdx===idx" class="ph-bold ph-spinner animate-spin"></i><i v-else class="ph-bold ph-magic-wand"></i></button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button @click="item.showTicketInput = !item.showTicketInput" class="text-xs text-slate-400 hover:text-teal-500"><i class="ph-bold ph-ticket"></i></button>
                                            <button @click="removeItem(idx)" class="text-slate-300 hover:text-red-500"><i class="ph-bold ph-trash"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="item.showTicketInput || item.ticketUrl" class="mt-2 flex gap-2">
                                        <input v-model="item.ticketUrl" class="flex-1 text-xs border border-slate-200 rounded px-2 py-1" placeholder="ç¥¨åˆ¸é€£çµ...">
                                        <a v-if="item.ticketUrl" :href="item.ticketUrl" target="_blank" rel="noopener noreferrer" class="bg-green-500 text-white text-xs px-2 py-1 rounded flex items-center">é–‹å•Ÿ</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                         <button @click="addItem" class="flex-1 bg-white border border-dashed border-teal-300 text-teal-500 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-teal-50"><i class="ph-bold ph-plus"></i> æ–°å¢è¡Œç¨‹</button>
                         <button @click="aiPlanDay" :disabled="isAiPlanning" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 rounded-xl font-bold flex items-center gap-2 shadow-md"><i v-if="isAiPlanning" class="ph-bold ph-spinner animate-spin"></i><i v-else class="ph-fill ph-sparkle"></i> AI</button>
                    </div>
                </div>
                <div class="mt-12 pt-6 border-t border-slate-200 text-center">
                    <button @click="removeCurrentDay" class="text-xs text-red-300 hover:text-red-500 flex items-center justify-center gap-1 mx-auto"><i class="ph-bold ph-trash"></i> åˆªé™¤é€™ä¸€å¤©</button>
                </div>
            </div>
            </transition>

            <!-- ç¥¨åˆ¸æª¢è¦– (Ticket View) -->
            <div v-if="viewMode === 'ticket'" class="p-4 pb-24 animate-fade-in">
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-duotone ph-ticket text-teal-500"></i> ç¥¨åˆ¸ç¸½è¦½</h2>
                    <p class="text-xs text-slate-400 mt-1">æ­¤è™•é¡¯ç¤ºæ‰‹å‹•æ–°å¢çš„ç¥¨åˆ¸ï¼Œä»¥åŠè¡Œç¨‹ä¸­æœ‰è²¼ä¸Šé€£çµçš„é …ç›®ã€‚</p>
                </div>

                <!-- æ‰‹å‹•æ–°å¢ç¥¨åˆ¸å€ -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-6">
                    <h3 class="text-xs font-bold text-teal-600 uppercase mb-3 flex items-center gap-1"><i class="ph-bold ph-plus-circle"></i> æ–°å¢é€šç”¨ç¥¨åˆ¸</h3>
                    <div class="space-y-2">
                        <input v-model="newTicket.name" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2" placeholder="ç¥¨åˆ¸åç¨± (ä¾‹å¦‚: JR Pass)...">
                        <div class="relative">
                            <i class="ph-bold ph-link absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input v-model="newTicket.url" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 pl-9" placeholder="é›²ç«¯ç¡¬ç¢Ÿé€£çµ...">
                        </div>
                        <input v-model="newTicket.note" class="w-full text-xs bg-slate-50 border border-slate-200 rounded-lg px-3 py-2" placeholder="å‚™è¨» (é¸å¡«)...">
                        <button @click="addManualTicket" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 rounded-lg transition text-sm">æ–°å¢ç¥¨åˆ¸</button>
                    </div>
                </div>

                <!-- é€šç”¨ç¥¨åˆ¸åˆ—è¡¨ -->
                <div v-if="additionalTickets && additionalTickets.length > 0" class="mb-6">
                    <div class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide ml-1">ğŸ“ é€šç”¨ç¥¨åˆ¸ / æœªæ’ç¨‹</div>
                    <div class="space-y-3">
                        <div v-for="(ticket, idx) in additionalTickets" :key="ticket.id" class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex gap-3 relative group">
                            <div class="shrink-0 w-10 h-10 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-xl">
                                <i class="ph-fill ph-ticket"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <div class="font-bold text-slate-800 text-sm truncate">{{ ticket.name }}</div>
                                    <button @click="removeManualTicket(idx)" class="text-slate-300 hover:text-red-500"><i class="ph-bold ph-trash"></i></button>
                                </div>
                                <div class="text-xs text-slate-400 mt-0.5 truncate">{{ ticket.note }}</div>
                                <div class="mt-2">
                                    <a v-if="ticket.url" :href="ticket.url" target="_blank" rel="noopener noreferrer" class="bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold py-1.5 px-3 rounded-lg inline-flex items-center gap-1 transition shadow-sm">
                                        <i class="ph-bold ph-arrow-square-out"></i> é–‹å•Ÿ
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¡Œç¨‹ç¥¨åˆ¸åˆ—è¡¨ -->
                <div v-if="hasAnyItineraryTickets" class="space-y-6">
                    <div class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide ml-1 border-t border-slate-200 pt-4">ğŸ“… è¡Œç¨‹ç¥¨åˆ¸ (å·²é€£çµ)</div>
                    <div v-for="(day, dIdx) in days" :key="dIdx" class="relative">
                        <div v-if="hasTicketItems(day)">
                            <div class="flex items-center gap-2 mb-3 sticky top-0 bg-[#F3F4F6] z-10 py-1">
                                <div class="bg-teal-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded">Day {{ dIdx + 1 }}</div>
                                <div class="text-xs font-bold text-slate-500">{{ day.date.split('(')[0] }}</div>
                            </div>
                            
                            <div class="space-y-3 pl-2 border-l-2 border-slate-200 ml-1">
                                <div v-for="item in getTicketItems(day)" :key="item.id" class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex gap-3 relative">
                                    <div class="shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-xl bg-green-100 text-green-600">
                                        <i v-if="item.type === 'flight'" class="ph-fill ph-airplane-tilt"></i>
                                        <i v-else-if="item.type === 'transport'" class="ph-fill ph-train"></i>
                                        <i v-else-if="item.type === 'hotel'" class="ph-fill ph-bed"></i>
                                        <i v-else class="ph-fill ph-ticket"></i>
                                    </div>
                                    
                                    <div class="flex-1 min-w-0">
                                        <div class="font-bold text-slate-800 text-sm truncate">{{ item.activity || 'æœªå‘½åè¡Œç¨‹' }}</div>
                                        <div class="text-xs text-slate-400 flex items-center gap-1 mt-0.5">
                                            <i class="ph-bold ph-clock"></i> {{ item.time || '--:--' }}
                                        </div>
                                        <div class="mt-2">
                                            <a :href="item.ticketUrl" target="_blank" rel="noopener noreferrer" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1.5 px-3 rounded-lg inline-flex items-center gap-1 transition shadow-sm">
                                                <i class="ph-bold ph-arrow-square-out"></i> é–‹å•Ÿ
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="(!additionalTickets || additionalTickets.length === 0) && !hasAnyItineraryTickets" class="text-center py-10 text-slate-400">
                    <i class="ph-duotone ph-ticket text-4xl mb-2"></i>
                    <p class="text-sm">å°šç„¡ç¥¨åˆ¸è³‡æ–™</p>
                    <p class="text-xs mt-1">è«‹æ‰‹å‹•æ–°å¢ï¼Œæˆ–æ˜¯å°‡ç¥¨åˆ¸é€£çµè²¼åˆ°è¡Œç¨‹ä¸­ã€‚</p>
                </div>
            </div>

            <!-- åˆ†å¸³è¦–åœ– -->
            <div v-if="viewMode === 'money'" class="p-4 pb-24 animate-fade-in">
                <div class="bg-teal-600 text-white rounded-2xl p-6 shadow-lg mb-6 text-center relative">
                    <div class="absolute top-4 right-4 flex flex-col items-end">
                        <label class="text-[10px] text-teal-200 mb-1">åŒ¯ç‡ ({{ currencyLabel }})</label>
                        <input v-model.number="exchangeRate" type="number" step="0.001" class="w-16 text-right text-xs text-teal-900 rounded px-1 py-0.5">
                    </div>
                    <div class="text-sm opacity-80 mb-1">ç¸½æ”¯å‡º Total</div>
                    <div class="text-4xl font-bold font-mono">{{ currencySymbol }} {{ totalExpense.toLocaleString() }}</div>
                    <div class="text-lg font-bold text-teal-200 mt-1">â‰ˆ NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}</div>
                </div>
                <div class="mb-4 bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                    <div class="text-xs font-bold text-slate-400 mb-2">åˆ†å¸³æˆå“¡ (ç”¨é€—è™Ÿåˆ†éš”)</div>
                    <input v-model="participantsStr" @change="updateParticipants" class="w-full text-sm bg-slate-50 rounded px-2 py-1 border border-slate-200" placeholder="ä¾‹å¦‚: æˆ‘, æœ‹å‹A, æœ‹å‹B">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <div v-for="p in participants" :key="p" class="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                        <div class="text-xs text-slate-400 mb-1">{{ p }} å¢Šä»˜</div>
                        <div class="text-sm font-bold text-teal-600">{{ currencySymbol }}{{ paidByPerson[p]?.toLocaleString() || 0 }}</div>
                    </div>
                </div>
                <div v-if="settlementPlan.length > 0" class="bg-teal-50 rounded-xl p-4 mb-6 border border-teal-100">
                    <h3 class="text-xs font-bold text-teal-400 uppercase tracking-wide mb-3">çµå¸³å»ºè­°</h3>
                    <div class="space-y-2">
                        <div v-for="(plan, idx) in settlementPlan" :key="idx" class="flex items-center justify-between text-sm bg-white p-2 rounded-lg shadow-sm">
                            <span class="font-bold text-slate-600">{{ plan.from }} <i class="ph-bold ph-arrow-right text-xs"></i> {{ plan.to }}</span>
                            <span class="font-mono font-bold text-teal-600">{{ currencySymbol }}{{ plan.amount.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-slate-100">
                    <div class="flex gap-2 mb-2">
                        <input v-model="newExpense.item" placeholder="é …ç›®" class="w-[65%] bg-slate-50 border-none rounded-lg text-sm px-3 py-2">
                        <select v-model="newExpense.payer" class="flex-1 bg-slate-50 border-none rounded-lg text-sm px-2 py-2 min-w-0">
                            <option v-for="p in participants" :value="p">{{ p }}</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input v-model.number="newExpense.amount" type="number" :placeholder="currencySymbol + ' é‡‘é¡'" class="w-full bg-slate-50 border-none rounded-lg text-sm pl-3 pr-3 py-2 font-mono">
                        <button @click="addExpense" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold"><i class="ph-bold ph-plus"></i></button>
                    </div>
                </div>
                <div class="space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 text-xs font-bold">{{ exp.payer.charAt(0) }}</div>
                            <div><div class="font-bold text-slate-700 text-sm">{{ exp.item }}</div></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-bold text-slate-700">{{ currencySymbol }}{{ exp.amount.toLocaleString() }}</span>
                            <button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400"><i class="ph-fill ph-x-circle"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¿»è­¯åŠŸèƒ½ -->
            <div v-if="viewMode === 'translate'" class="p-6 h-full flex flex-col justify-center items-center pb-32 animate-fade-in">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Google ç¿»è­¯æ·å¾‘</h2>
                    <p class="text-sm text-slate-400">è«‹é¸æ“‡æ‚¨éœ€è¦çš„ç¿»è­¯æ¨¡å¼</p>
                </div>
                <div class="w-full mb-4">
                    <a href="https://translate.google.com/?op=images" target="_blank" class="block w-full">
                        <button class="w-full bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left"><div class="text-xs opacity-80 mb-1 tracking-wider">èœå–® / çœ‹æ¿</div><div class="text-2xl font-bold">ç…§ç›¸ç¿»è­¯ <i class="ph-bold ph-camera text-sm"></i></div></div>
                                <i class="ph-duotone ph-camera-plus text-3xl opacity-60 group-hover:opacity-100"></i>
                            </div>
                        </button>
                    </a>
                </div>
                <div class="w-full mb-4">
                    <a :href="`https://translate.google.com/?sl=zh-TW&tl=${setup.langCode}&op=translate`" target="_blank" class="block w-full">
                        <button class="w-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left"><div class="text-xs opacity-80 mb-1 tracking-wider">æˆ‘èªªä¸­æ–‡ (è½‰{{ setup.langName }})</div><div class="text-2xl font-bold">CH <i class="ph-bold ph-arrow-right text-sm"></i> {{ setup.langCode.toUpperCase() }}</div></div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl opacity-60 group-hover:opacity-100"></i>
                            </div>
                        </button>
                    </a>
                </div>
                <div class="w-full">
                    <a :href="`https://translate.google.com/?sl=${setup.langCode}&tl=zh-TW&op=translate`" target="_blank" class="block w-full">
                        <button class="w-full bg-white border-2 border-slate-200 text-slate-700 rounded-2xl p-6 shadow-sm active:scale-95 transition-transform relative overflow-hidden group hover:border-indigo-300">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left"><div class="text-xs text-slate-400 mb-1 tracking-wider">å°æ–¹èªª{{ setup.langName }} (è½‰ä¸­æ–‡)</div><div class="text-2xl font-bold font-jp">{{ setup.langCode.toUpperCase() }} <i class="ph-bold ph-arrow-right text-sm"></i> CH</div></div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                            </div>
                        </button>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- å´é‚Šæ¬„ (æ—…ç¨‹é¸å–®) -->
        <transition name="slide">
            <div v-if="showTripMenu" class="fixed inset-0 z-50 flex">
                <div class="bg-white w-4/5 max-w-xs h-full shadow-2xl flex flex-col relative z-50 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-800">æˆ‘çš„æ—…ç¨‹</h2>
                        <button @click="showTripMenu = false" class="text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-xl"></i></button>
                    </div>
                    <button @click="createNewTrip" class="w-full py-3 mb-6 border-2 border-dashed border-teal-400 text-teal-600 rounded-xl font-bold hover:bg-teal-50 flex items-center justify-center gap-2">
                        <i class="ph-bold ph-plus-circle"></i> å»ºç«‹æ–°æ—…ç¨‹
                    </button>
                    <div class="flex-1 overflow-y-auto space-y-3 hide-scroll">
                        <div v-if="tripList.length === 0" class="text-center text-slate-400 py-4 text-xs">å°šç„¡æœ¬æ©Ÿè³‡æ–™</div>
                        <div v-for="trip in tripList" :key="trip.id" 
                             @click="loadLocalTrip(trip.id)"
                             class="p-4 rounded-xl border transition cursor-pointer relative group"
                             :class="currentTripId === trip.id ? 'bg-teal-50 border-teal-500 shadow-sm' : 'bg-slate-50 border-transparent hover:bg-slate-100'">
                            <div class="font-bold text-slate-800">{{ trip.destination || 'æœªå‘½åè¡Œç¨‹' }}</div>
                            <div class="text-xs text-slate-400 mt-1">{{ trip.startDate }} â€¢ {{ trip.daysCount }} å¤©</div>
                            <button v-if="tripList.length > 1" @click.stop="deleteTrip(trip.id)" class="absolute right-3 top-3 text-slate-300 hover:text-red-500 p-1"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                </div>
                <div class="flex-1 bg-black/50 backdrop-blur-sm z-40" @click="showTripMenu = false"></div>
            </div>
        </transition>
        
        <!-- è¨­å®š & åˆå§‹è¦–çª— -->
        <div v-if="showSetupModal" class="absolute inset-0 bg-teal-800/90 backdrop-blur-sm z-50 flex items-center justify-center p-6 animate-fade-in">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">å»ºç«‹æ–°æ—…ç¨‹</h2>
                    <p class="text-sm text-slate-400">ç™»å…¥å¾Œå¯å»ºç«‹é›²ç«¯å…±ç”¨è¡Œç¨‹</p>
                </div>
                <div class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-400">ç›®çš„åœ°</label><input v-model="setup.destination" class="w-full border rounded-xl px-4 py-3 font-bold"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-slate-400">æ—¥æœŸ</label><input v-model="setup.startDate" type="date" class="w-full border rounded-xl px-3 py-2 text-sm"></div>
                        <div><label class="text-xs font-bold text-slate-400">å¤©æ•¸</label><input v-model.number="setup.days" type="number" class="w-full border rounded-xl px-3 py-2 text-center font-bold"></div>
                    </div>
                    <!-- å¢åŠ  Loading ç‹€æ…‹ -->
                    <button @click="initTrip" :disabled="isRateLoading" class="w-full bg-teal-600 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 flex items-center justify-center gap-2">
                        <span v-if="isRateLoading" class="animate-spin"><i class="ph-bold ph-spinner"></i></span>
                        <span v-else>é–‹å§‹è¦åŠƒ <i class="ph-bold ph-arrow-right"></i></span>
                    </button>
                    <!-- é›²ç«¯å»ºç«‹æŒ‰éˆ• -->
                    <button @click="createCloudTrip" :disabled="isRateLoading" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 flex items-center justify-center gap-2">
                        <span>å»ºç«‹æ–°æ—…ç¨‹ (å¤šäººç‰ˆ)</span>
                    </button>
                    <div v-if="tripList.length > 0" class="mt-6 pt-4 border-t border-slate-100">
                        <button @click="showSetupModal=false; showTripMenu=true" class="w-full text-slate-500 text-sm hover:text-teal-600">æª¢è¦–æ­·å²è¡Œç¨‹</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¨­å®šè¦–çª— (API Key) -->
        <div v-if="showSettingsModal" class="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="showSettingsModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                <h2 class="text-xl font-bold mb-4">Gemini API Key</h2>
                <input v-model="geminiApiKey" type="password" class="w-full border rounded-xl px-3 py-2 mb-4" placeholder="AIza...">
                <button @click="showSettingsModal = false" class="w-full bg-teal-600 text-white font-bold py-2 rounded-xl">å„²å­˜</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // --- FIREBASE è¨­å®šå€ (è«‹å¡«å…¥ä½ çš„è¨­å®š) ---
        const firebaseConfig = {
            // è«‹å°‡ Firebase Console > Project Settings > General > Your apps è£¡é¢çš„ config è²¼åœ¨é€™è£¡
            apiKey: "ä½ çš„_API_KEY",
           authDomain: "mytravelapp-f9c1c.firebaseapp.com",
        projectId: "mytravelapp-f9c1c",
        storageBucket: "mytravelapp-f9c1c.firebasestorage.app",
        messagingSenderId: "1024870317388",
        appId: "1:1024870317388:web:772e1a90d888ab2107a3e9"
        };
        // ------------------------------------

        let appInstance, db;
        try {
            if (firebaseConfig.apiKey !== "ä½ çš„_API_KEY") {
                appInstance = initializeApp(firebaseConfig);
                db = getFirestore(appInstance);
                console.log("Firebase initialized");
            }
        } catch(e) { console.error(e); }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const app = createApp({
            setup() {
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const showSetupModal = ref(false);
                const showSettingsModal = ref(false);
                const showTripMenu = ref(false);
                const geminiApiKey = ref('');
                const itineraryList = ref(null);
                
                // Trip Data States
                const days = ref([]);
                const expenses = ref([]);
                const participants = ref(['æˆ‘']);
                const participantsStr = ref('æˆ‘');
                const exchangeRate = ref(0.215);
                const newExpense = ref({ item: '', amount: '', payer: 'æˆ‘' });
                const tripId = ref(null); 
                const currentTripId = ref(null); // Local ID
                const tripList = ref([]); // Local List
                const additionalTickets = ref([]);
                const newTicket = ref({ name: '', url: '', note: '' });
                const setup = ref({ destination: 'Tokyo', startDate: new Date().toISOString().split('T')[0], days: 5, rate: 0.215, currency: 'JPY', langCode: 'ja' });

                // UI Helpers
                const isRateLoading = ref(false);
                const isMapLoading = ref(false);
                const userLocation = ref(null);
                const weather = ref({ temp: null, icon: 'ph-sun', label: '' });
                const syncStatus = ref('');
                let isRemoteUpdate = false;

                // Recommendations & AI
                const recommendationsMap = reactive({});
                const isSearchingRecs = ref(false);
                const searchTargetIndex = ref('');
                const isAiPlanning = ref(false);
                const loadingNoteIdx = ref(null);

                let mapInstance = null;
                let userMarker = null;
                let geoWatchId = null;
                let sortableInstance = null;

                // --- 1. Helper Functions ---
                const createDayObject = (dateStr) => {
                    const d = new Date(dateStr);
                    if(isNaN(d.getTime())) return { fullDate: dateStr, shortDate: '--/--', date: 'Day', title: '', items: [], flight: {} };
                    const mm = d.getMonth() + 1;
                    const dd = d.getDate();
                    const w = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
                    return {
                        fullDate: dateStr,
                        shortDate: `${mm < 10 ? '0'+mm : mm}/${dd < 10 ? '0'+dd : dd}`,
                        date: `${mm < 10 ? '0'+mm : mm}/${dd < 10 ? '0'+dd : dd} (${w})`,
                        title: '',
                        items: [],
                        flight: { startTime: '', startAirport: '', number: '', endTime: '', endAirport: '', arrivalOffset: 0 }
                    };
                };

                const getTicketItems = (day) => {
                    if(!day || !day.items) return [];
                    return day.items.filter(item => {
                        return item.ticketUrl && item.ticketUrl.trim() !== '';
                    });
                };
                
                const getDayName = (dateStr) => {
                    if (!dateStr) return '';
                    const parts = dateStr.split('-');
                    const d = new Date(parts[0], parts[1] - 1, parts[2]); 
                    const map = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    return map[d.getDay()] || '';
                }

                const generateId = () => 'trip_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                const getWeatherIcon = (c) => { if (c===0) return 'ph-sun'; if (c<4) return 'ph-cloud-sun'; if (c<50) return 'ph-cloud-fog'; if (c<70) return 'ph-cloud-rain'; return 'ph-cloud'; };
                const getTimePeriod = (t) => { if(!t) return 'æ™‚é–“'; const h=parseInt(t.split(':')[0]); return h<5?'å‡Œæ™¨':h<11?'ä¸Šåˆ':h<14?'ä¸­åˆ':h<18?'ä¸‹åˆ':'æ™šä¸Š'; };
                const getDotColor = (t) => t==='food'?'bg-orange-400':t==='shop'?'bg-pink-400':t==='flight'?'bg-blue-500':t==='hotel'?'bg-indigo-500':'bg-teal-500';

                // --- 2. AI Functions (Defined BEFORE return) ---
                const callGeminiAPI = async (prompt) => {
                    if (!geminiApiKey.value) {
                        alert("è«‹å…ˆé»æ“Šå³ä¸Šè§’è¨­å®šé½’è¼ªï¼Œè¼¸å…¥æ‚¨çš„ Gemini API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ã€‚");
                        showSettingsModal.value = true;
                        return null;
                    }

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey.value}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }]
                    };
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json();
                        if (data.error) {
                            console.error("API Error:", data.error);
                            alert("API é€£ç·šéŒ¯èª¤: " + (data.error.message || "æœªçŸ¥éŒ¯èª¤"));
                            return null;
                        }
                        return data.candidates?.[0]?.content?.parts?.[0]?.text;
                    } catch (e) {
                        console.error("Gemini API Error:", e);
                        alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key");
                        return null;
                    }
                };

                const aiPlanDay = async () => {
                    if (!setup.value.destination) { alert('è«‹å…ˆè¨­å®šç›®çš„åœ°'); return; }
                    if (isAiPlanning.value) return;
                    isAiPlanning.value = true;
                    
                    const prompt = `
                    You are a helpful travel assistant. Please plan a one-day itinerary for Day ${currentDayIdx.value + 1} in ${setup.value.destination}.
                    Return a JSON array of objects. Do not include markdown formatting (like \`\`\`json).
                    Each object must have:
                    - "time" (string, HH:MM format, start from morning)
                    - "type" (string, one of: "spot", "food", "shop", "transport", "hotel")
                    - "activity" (string, name of the activity or place)
                    - "location" (string, specific place name for map search)
                    - "note" (string, brief tip or description, max 20 words)
                    
                    Language: Traditional Chinese (Taiwan).
                    Generate about 5-7 items.
                    `;

                    const result = await callGeminiAPI(prompt);
                    if (result) {
                        try {
                            const jsonStr = result.replace(/```json/g, '').replace(/```/g, '').trim();
                            const newItems = JSON.parse(jsonStr);
                            if (Array.isArray(newItems)) {
                                const itemsWithId = newItems.map(i => ({ ...i, id: Date.now() + Math.random(), ticketUrl: '' }));
                                if (!currentDay.value.items) currentDay.value.items = [];
                                currentDay.value.items.push(...itemsWithId);
                            } else {
                                alert("AI æ ¼å¼è§£æå¤±æ•—ï¼Œè«‹é‡è©¦");
                            }
                        } catch (e) {
                            console.error(e);
                            alert("AI å›å‚³æ ¼å¼æœ‰èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                        }
                    } 
                    isAiPlanning.value = false;
                };

                const askAiAboutPlace = async (item) => {
                    if (!item.location) return;
                    const idx = currentDay.value.items.indexOf(item);
                    loadingNoteIdx.value = idx;
                    
                    const prompt = `
                    Briefly describe "${item.location}" in ${setup.value.destination} for a tourist. 
                    Language: Traditional Chinese (Taiwan). 
                    Max 30 words. Focus on what makes it special.
                    `;
                    
                    const result = await callGeminiAPI(prompt);
                    if (result) {
                        item.note = result.trim();
                        await nextTick();
                        resizeAllTextareas(); 
                    }
                    loadingNoteIdx.value = null;
                };

                // --- 3. Computed Properties ---
                const currentDay = computed(() => {
                    // Safe access with fallback
                    if (!days.value || days.value.length === 0) return createDayObject(new Date().toISOString().split('T')[0]);
                    const day = days.value[currentDayIdx.value];
                    if (!day) return createDayObject(new Date().toISOString().split('T')[0]);
                    
                    // Ensure structure exists
                    if (!day.items) day.items = [];
                    if (!day.flight) day.flight = {};
                    return day;
                });
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                
                const paidByPerson = computed(() => {
                    const map = {};
                    participants.value.forEach(p => map[p] = 0);
                    expenses.value.forEach(e => { if (map[e.payer] === undefined) map[e.payer] = 0; map[e.payer] += e.amount; });
                    return map;
                });
                const settlementPlan = computed(() => {
                    if (totalExpense.value === 0) return [];
                    const average = totalExpense.value / participants.value.length;
                    let balances = participants.value.map(p => ({ name: p, val: (paidByPerson.value[p] || 0) - average }));
                    let debtors = balances.filter(b => b.val < -1).sort((a, b) => a.val - b.val);
                    let creditors = balances.filter(b => b.val > 1).sort((a, b) => b.val - a.val);
                    const result = [];
                    let i = 0; let j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let debtor = debtors[i];
                        let creditor = creditors[j];
                        let amount = Math.min(Math.abs(debtor.val), creditor.val);
                        amount = Math.round(amount);
                        if (amount > 0) result.push({ from: debtor.name, to: creditor.name, amount: amount });
                        debtor.val += amount; creditor.val -= amount;
                        if (Math.abs(debtor.val) < 1) i++;
                        if (creditor.val < 1) j++;
                    }
                    return result;
                });

                const currencyLabel = computed(() => setup.value.currency || 'å¤–å¹£');
                const currencySymbol = computed(() => ({ 'JPY': 'Â¥', 'USD': '$', 'KRW': 'â‚©', 'TWD': 'NT$' }[setup.value.currency] || '$'));
                const weatherDisplay = computed(() => ({ temp: weather.value.temp || '--', icon: weather.value.icon || 'ph-sun', label: weather.value.label || 'å¤©æ°£' }));
                const isKoreaTrip = computed(() => setup.value.langCode === 'ko');
                
                const hasAnyItineraryTickets = computed(() => {
                    if (!days.value) return false;
                    return days.value.some(day => getTicketItems(day).length > 0);
                });
                
                const hasTicketItems = (day) => getTicketItems(day).length > 0;

                const syncStatusClass = computed(() => {
                    if(tripId.value) return syncStatus.value === 'å·²åŒæ­¥' ? 'sync-saved' : 'sync-saving';
                    return 'sync-local';
                });
                const syncStatusIcon = computed(() => tripId.value ? 'ph-cloud-check' : 'ph-floppy-disk');

                // --- 4. Other UI/Business Functions ---
                const createTripMode = () => {
                    tripId.value = null;
                    showSetupModal.value = true;
                };

                const updateParticipants = () => { participants.value = participantsStr.value.split(',').map(s=>s.trim()).filter(s=>s); };
                const updateDate = (e, day) => {
                    const val = e.target.value; if(!val) return;
                    const newObj = createDayObject(val);
                    day.fullDate = newObj.fullDate;
                    day.shortDate = newObj.shortDate;
                    day.date = newObj.date;
                };
                const addDay = () => {
                    const lastDay = days.value[days.value.length - 1];
                    const nextDate = new Date(lastDay.fullDate);
                    nextDate.setDate(nextDate.getDate() + 1);
                    days.value.push(createDayObject(nextDate.toISOString().split('T')[0]));
                };
                const toggleFlightCard = () => {
                     if (currentDay.value.flight && (currentDay.value.flight.number || currentDay.value.flight.startTime)) { 
                         if(confirm('ç§»é™¤èˆªç­?')) currentDay.value.flight = {}; 
                     } else { 
                         currentDay.value.flight = { type: 'arrival', startTime: '10:00', startAirport: 'TPE', number: 'FLIGHT', endTime: '14:00', endAirport: 'DEST', arrivalOffset: 0 }; 
                     }
                };
                const addItem = () => {
                    // Safe add
                    if (!currentDay.value.items) currentDay.value.items = [];
                    currentDay.value.items.push({ 
                        id: Date.now() + Math.random(), 
                        time: '', type: 'spot', activity: '', location: '', note: '', ticketUrl: '', showTicketInput: false 
                    });
                };
                const removeItem = (idx) => currentDay.value.items.splice(idx, 1);
                const addExpense = () => { if(newExpense.value.item) { expenses.value.unshift({...newExpense.value}); newExpense.value.item=''; newExpense.value.amount=''; }};
                const removeExpense = (idx) => expenses.value.splice(idx, 1);
                const removeCurrentDay = () => { if(days.value.length>1 && confirm('åˆªé™¤?')) days.value.splice(currentDayIdx.value, 1); };

                const getGoogleMapLink = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';
                const getNaverMapLink = (loc) => loc ? `https://map.naver.com/p/search/${encodeURIComponent(loc)}` : '#';
                
                const detectRate = async () => {
                    if(!setup.value.destination) return;
                    isRateLoading.value = true;
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(setup.value.destination)}&limit=1&addressdetails=1`);
                        const geoData = await geoRes.json();
                        if(geoData?.[0]?.address?.country_code) {
                            const info = countryInfoMap[geoData[0].address.country_code.toLowerCase()] || {c:'USD',l:'en',n:'è‹±æ–‡'};
                            setup.value.currency = info.c; setup.value.langCode = info.l; setup.value.langName = info.n;
                            if(info.c === 'TWD') setup.value.rate = 1;
                            else {
                                const rRes = await fetch(`https://api.exchangerate-api.com/v4/latest/${info.c}`);
                                const rData = await rRes.json();
                                if(rData?.rates?.TWD) setup.value.rate = rData.rates.TWD;
                            }
                        }
                    } catch(e) {} finally { isRateLoading.value = false; }
                };

                const fetchWeather = async (locName) => {
                    try {
                        weather.value.location = locName;
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locName)}&limit=1`);
                        const geoData = await geoRes.json();
                        if(geoData?.[0]) {
                            const {lat, lon} = geoData[0];
                            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&forecast_days=16`);
                            const wData = await wRes.json();
                            weather.value.temp = Math.round(wData.current_weather.temperature);
                            weather.value.icon = getWeatherIcon(wData.current_weather.weathercode);
                            if(wData.daily) weather.value.daily = wData.daily;
                        }
                    } catch(e) { weather.value.temp = '--'; }
                };

                const copyShareLink = () => {
                    if (!tripId.value) {
                        alert("ç›®å‰ç‚ºæœ¬æ©Ÿæ¨¡å¼ï¼Œè³‡æ–™å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚\n\nå¦‚éœ€åˆ†äº«çµ¦æœ‹å‹ï¼Œè«‹é»æ“Šã€Œå»ºç«‹æ–°æ—…ç¨‹ (å¤šäººç‰ˆ)ã€ä¾†ç”¢ç”Ÿé›²ç«¯é€£çµã€‚");
                        return;
                    }
                    const url = window.location.href;
                    navigator.clipboard.writeText(url).then(() => alert('é€£çµå·²è¤‡è£½ï¼å‚³çµ¦æœ‹å‹å³å¯å…±åŒç·¨è¼¯ã€‚'));
                };

                const addManualTicket = () => { 
                    if (newTicket.value.name) {
                        if (!additionalTickets.value) additionalTickets.value = [];
                        additionalTickets.value.push({...newTicket.value, id: Date.now()}); 
                        newTicket.value={name:'',url:'',note:''}; 
                    } else { alert("è«‹è¼¸å…¥ç¥¨åˆ¸åç¨±"); }
                };
                const removeManualTicket = (idx) => {
                    if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç¥¨åˆ¸?")) additionalTickets.value.splice(idx, 1);
                };

                const searchNearby = async (item, idx) => {
                    if (!item.location || item.type !== 'food') return;
                    const key = `${currentDayIdx.value}-${idx}`;
                    searchTargetIndex.value = key;
                    isSearchingRecs.value = true;
                    recommendationsMap[key] = []; 
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}&limit=1`);
                        const geoData = await geoRes.json();
                        if (geoData && geoData.length > 0) {
                            const lat = geoData[0].lat;
                            const lon = geoData[0].lon;
                            const searchRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=restaurant near ${item.location}&limit=4`);
                            const searchData = await searchRes.json();
                            recommendationsMap[key] = searchData.map(place => ({
                                name: place.name || place.display_name.split(',')[0], 
                                location: place.name || place.display_name.split(',')[0],
                                note: 'æ¨è–¦åœ°é»'
                            }));
                            if (recommendationsMap[key].length === 0) recommendationsMap[key] = [{ name: 'é™„è¿‘ç„¡æ¨è–¦', location: item.location, note: '' }];
                        }
                    } catch (e) { console.error("æ¨è–¦æœå°‹å¤±æ•—", e); } finally { isSearchingRecs.value = false; searchTargetIndex.value = ''; }
                };
                const applyRecommendation = (item, rec) => { item.activity = rec.name; item.location = rec.name; };

                // --- 5. Sortable & Resize ---
                const adjustHeight = (el) => {
                    if (!el) return;
                    el.style.height = 'auto'; 
                    el.style.height = (el.scrollHeight) + 'px';
                };
                const resizeAllTextareas = async () => {
                    await nextTick();
                    const textareas = document.querySelectorAll('.auto-resize-textarea');
                    textareas.forEach(adjustHeight);
                };
                watch(() => currentDay.value, resizeAllTextareas, { deep: true, immediate: true });

                const initSortable = () => {
                    if (sortableInstance) sortableInstance.destroy();
                    if (!itineraryList.value) return;
                    if (typeof Sortable === 'undefined') return;
                    
                    sortableInstance = new Sortable(itineraryList.value, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'sortable-ghost',
                        onEnd: (evt) => {
                            const item = currentDay.value.items.splice(evt.oldIndex, 1)[0];
                            currentDay.value.items.splice(evt.newIndex, 0, item);
                        }
                    });
                };
                watch([viewMode, currentDayIdx], async () => {
                    if (viewMode.value === 'plan') {
                        await nextTick();
                        initSortable();
                    }
                });

                // --- 6. Data Persistence ---
                const saveLocalTrip = () => {
                    if (!currentTripId.value) return;
                    localStorage.setItem(`${currentTripId.value}_days`, JSON.stringify(days.value));
                    localStorage.setItem(`${currentTripId.value}_exp`, JSON.stringify(expenses.value));
                    localStorage.setItem(`${currentTripId.value}_rate`, exchangeRate.value.toString());
                    localStorage.setItem(`${currentTripId.value}_users`, participantsStr.value);
                    localStorage.setItem(`${currentTripId.value}_config`, JSON.stringify(setup.value));
                    localStorage.setItem(`${currentTripId.value}_tickets`, JSON.stringify(additionalTickets.value));
                };

                const deleteLocalTrip = (id) => {
                    if(!confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿç„¡æ³•å¾©åŸã€‚')) return;
                    tripList.value = tripList.value.filter(t => t.id !== id);
                    localStorage.setItem('travel_app_index', JSON.stringify(tripList.value));
                    localStorage.removeItem(`${id}_days`);
                    localStorage.removeItem(`${id}_exp`);
                    localStorage.removeItem(`${id}_users`);
                    localStorage.removeItem(`${id}_rate`);
                    localStorage.removeItem(`${id}_config`);
                    localStorage.removeItem(`${id}_tickets`);
                    
                    if(currentTripId.value === id) {
                        currentTripId.value = null;
                        days.value = [];
                        showTripMenu.value = false;
                        showSetupModal.value = true;
                    }
                };

                const loadTripList = () => {
                    const list = localStorage.getItem('travel_app_index');
                    tripList.value = list ? JSON.parse(list) : [];
                };

                const loadLocalTrip = (id) => {
                    currentTripId.value = id;
                    showSetupModal.value = false;
                    showTripMenu.value = false; // Close menu
                    syncStatus.value = 'æœ¬æ©Ÿæ¨¡å¼';
                    
                    const lDays = localStorage.getItem(`${id}_days`);
                    const lExp = localStorage.getItem(`${id}_exp`);
                    const lUsers = localStorage.getItem(`${id}_users`);
                    const lRate = localStorage.getItem(`${id}_rate`);
                    const lConf = localStorage.getItem(`${id}_config`);
                    const lAddTickets = localStorage.getItem(`${id}_tickets`);

                    if(lDays) days.value = JSON.parse(lDays);
                    if(lExp) expenses.value = JSON.parse(lExp);
                    if(lUsers) { participantsStr.value = lUsers; updateParticipants(); }
                    if(lRate) exchangeRate.value = parseFloat(lRate);
                    // Safe parsing
                    if(lAddTickets) { try { additionalTickets.value = JSON.parse(lAddTickets) || []; } catch(e){ additionalTickets.value=[]; } } 
                    else { additionalTickets.value = []; }

                    if(lConf) {
                        const conf = JSON.parse(lConf);
                        setup.value = conf;
                        fetchWeather(conf.destination);
                    }
                    
                    // Auto-Healing Data
                    if(Array.isArray(days.value)) {
                         days.value.forEach(day => {
                            if(!day.items) day.items = [];
                            day.items.forEach(item => { if(!item.id) item.id = Date.now() + Math.random(); });
                        });
                    } else {
                        days.value = [];
                    }
                    
                    initSortable();
                };

                const createNewTrip = () => {
                    showTripMenu.value = false;
                    showSetupModal.value = true;
                }
                const switchTrip = (id) => {
                    loadLocalTrip(id);
                }
                const deleteTrip = (id) => {
                    deleteLocalTrip(id);
                }
                
                // é›²ç«¯åŠŸèƒ½
                const createCloudTrip = async () => {
                     if (!setup.value.destination) return alert('è«‹è¼¸å…¥ç›®çš„åœ°');
                     if (!db) return alert('Firebase æœªé€£çµ');
                     
                     // FORCE RELOAD RATE
                     if (setup.value.currency === 'JPY' && setup.value.destination.toLowerCase().includes('korea')) {
                        await detectRate();
                    }

                     const newDays = Array.from({length: setup.value.days}, (_, i) => {
                        const d = new Date(setup.value.startDate); d.setDate(d.getDate() + i);
                        return createDayObject(d.toISOString().split('T')[0]);
                    });
                    
                    try {
                        const newId = 'trip_' + Date.now();
                        await setDoc(doc(db, "trips", newId), {
                            days: newDays,
                            expenses: [],
                            participantsStr: 'æˆ‘',
                            rate: setup.value.rate,
                            config: setup.value,
                            additionalTickets: [],
                            lastUpdate: new Date()
                        });
                        tripId.value = newId;
                        currentTripId.value = null;
                        bindCloudListener(newId);
                        window.history.pushState({}, '', `?trip_id=${newId}`);
                        showSetupModal.value = false;
                    } catch (e) { alert("å»ºç«‹é›²ç«¯è¡Œç¨‹å¤±æ•—: " + e.message); }
                };

                const saveToCloud = debounce(async () => {
                    if (!tripId.value || !db || isRemoteUpdate) return;
                    syncStatus.value = 'å„²å­˜ä¸­...';
                    try {
                        await updateDoc(doc(db, "trips", tripId.value), {
                            days: days.value,
                            expenses: expenses.value,
                            participantsStr: participantsStr.value,
                            rate: exchangeRate.value,
                            config: setup.value,
                            additionalTickets: additionalTickets.value,
                            lastUpdate: new Date()
                        });
                        setTimeout(() => syncStatus.value = 'å·²åŒæ­¥', 500);
                    } catch (e) { syncStatus.value = 'å„²å­˜å¤±æ•—'; }
                }, 1000);

                const bindCloudListener = (id) => {
                    if (!db) return;
                    onSnapshot(doc(db, "trips", id), (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            isRemoteUpdate = true;
                            
                            let rawDays = data.days;
                            if (rawDays && !Array.isArray(rawDays) && typeof rawDays === 'object') {
                                rawDays = Object.keys(rawDays).sort((a,b)=>Number(a)-Number(b)).map(k => rawDays[k]);
                            }
                            days.value = Array.isArray(rawDays) ? rawDays : [];

                            days.value.forEach(day => {
                                if (!day.date || !day.shortDate || !day.fullDate) {
                                    const baseDate = day.fullDate || day.date?.split(' ')[0] || new Date().toISOString().split('T')[0];
                                    const newObj = createDayObject(baseDate);
                                    day.fullDate = newObj.fullDate;
                                    day.shortDate = newObj.shortDate;
                                    day.date = newObj.date;
                                }
                                if(!day.items) day.items = [];
                                day.items.forEach(item => {
                                    if(!item.id) item.id = Date.now() + Math.random();
                                    if(item.ticketUrl === undefined) item.ticketUrl = '';
                                });
                            });

                            expenses.value = data.expenses || [];
                            participantsStr.value = data.participantsStr || '';
                            exchangeRate.value = data.rate;
                            
                            const config = data.config || {};
                            setup.value = {
                                destination: config.destination || '',
                                startDate: config.startDate || config.startdate || new Date().toISOString().split('T')[0],
                                days: config.days || 1,
                                rate: config.rate || 0.215,
                                currency: config.currency || 'JPY',
                                langCode: config.langCode || 'ja'
                            };

                            additionalTickets.value = data.additionalTickets || [];
                            
                            updateParticipants();
                            fetchWeather(setup.value.destination);
                            
                            nextTick(() => { 
                                isRemoteUpdate = false; 
                                syncStatus.value = 'å·²åŒæ­¥';
                                setTimeout(() => syncStatus.value = '', 2000);
                                initSortable();
                            });
                            showSetupModal.value = false;
                        } else {
                            alert("è¡Œç¨‹ä¸å­˜åœ¨");
                        }
                    });
                };

                const initTrip = async () => {
                    if (!setup.value.destination) return alert('è«‹è¼¸å…¥ç›®çš„åœ°');
                    
                    // FORCE RELOAD RATE to ensure currency is correct before creating
                    if (setup.value.currency === 'JPY' && setup.value.destination.toLowerCase().includes('korea')) {
                        await detectRate();
                    }

                    const newDays = Array.from({length: setup.value.days}, (_, i) => {
                        const d = new Date(setup.value.startDate); d.setDate(d.getDate() + i);
                        return createDayObject(d.toISOString().split('T')[0]);
                    });

                    // Local Create
                    const newId = 'local_' + Date.now();
                    currentTripId.value = newId;
                    days.value = newDays;
                    
                    // Add to list metadata
                    tripList.value.unshift({ 
                        id: newId, 
                        destination: setup.value.destination, 
                        startDate: setup.value.startDate, 
                        daysCount: setup.value.days 
                    });
                    localStorage.setItem('travel_app_index', JSON.stringify(tripList.value));
                    
                    saveLocalTrip();
                    loadTripList();
                    showSetupModal.value = false;
                    initSortable();
                };

                const centerOnUser = () => { 
                    if(userLocation.value && mapInstance) {
                        mapInstance.flyTo([userLocation.value.lat, userLocation.value.lng], 15); 
                    }
                }; 

                const initMap = async () => { 
                    isMapLoading.value = true; await nextTick(); if (!document.getElementById('map')) return;
                    if (mapInstance) { mapInstance.remove(); mapInstance = null; }
                    mapInstance = L.map('map').setView([35.6895, 139.6917], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(mapInstance);
                    if ("geolocation" in navigator) {
                         if (geoWatchId !== null) navigator.geolocation.clearWatch(geoWatchId);
                         geoWatchId = navigator.geolocation.watchPosition(pos => {
                             userLocation.value = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                             const icon = L.divIcon({ className: 'custom-div-icon', html: "<div class='gps-pulse'></div>", iconSize: [14, 14] });
                             if (userMarker) userMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
                             else userMarker = L.marker([pos.coords.latitude, pos.coords.longitude], { icon: icon }).addTo(mapInstance);
                         }, err => {}, { enableHighAccuracy: true });
                    }
                    const locs = currentDay.value.items.filter(i => i.location);
                    const bounds = L.latLngBounds();
                    for (const item of locs) {
                        try { await new Promise(r => setTimeout(r, 500)); const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}`); const d = await res.json(); if (d && d.length > 0) { const lat = parseFloat(d[0].lat); const lon = parseFloat(d[0].lon); L.marker([lat, lon]).addTo(mapInstance).bindPopup(`<b>${item.activity}</b><br>${item.location}`); bounds.extend([lat, lon]); } } catch (e) {}
                    }
                    isMapLoading.value = false; 
                    if(locs.length > 0) mapInstance.fitBounds(bounds, { padding: [50, 50] });
                };
                
                watch(viewMode, (v) => { if(v === 'map') initMap(); });
                watch(currentDayIdx, () => { if(viewMode.value === 'map') initMap(); });

                // Watchers for Save
                watch([days, expenses, exchangeRate, participantsStr, additionalTickets], () => {
                    if (tripId.value) saveToCloud();
                    else if (currentTripId.value) saveLocalTrip();
                }, { deep: true });

                onMounted(async () => {
                    loadTripList();

                    const params = new URLSearchParams(window.location.search);
                    const tid = params.get('trip_id');

                    if (tid && db) {
                        tripId.value = tid;
                        bindCloudListener(tid);
                    } else {
                        if (tripList.value.length > 0) {
                            // Optionally auto load latest, here we just let user pick or create
                            // loadLocalTrip(tripList.value[0].id); 
                        }
                        showSetupModal.value = true;
                    }
                });

                return {
                    viewMode, currentDayIdx, days, currentDay, participants, participantsStr, 
                    expenses, newExpense, totalExpense, paidByPerson, settlementPlan, exchangeRate,
                    weatherDisplay, isMapLoading, userLocation, syncStatus, syncStatusClass, syncStatusIcon,
                    isKoreaTrip, hasAnyItineraryTickets, tripList, 
                    additionalTickets, newTicket, setup, showSetupModal, showSettingsModal, showTripMenu, geminiApiKey, loadingNoteIdx,
                    tripId, currentTripId,
                    loadLocalTrip, deleteLocalTrip, createTripMode, initTrip, createCloudTrip,
                    centerOnUser, updateDate, addDay, toggleFlightCard, addItem, removeItem, addExpense, removeExpense, updateParticipants, removeCurrentDay,
                    getGoogleMapLink, getNaverMapLink, getDayName, detectRate, 
                    addManualTicket, removeManualTicket, copyShareLink,
                    getTicketItems, hasTicketItems, openSetupModal: () => { showSetupModal.value = true; showTripMenu.value = false; }, adjustHeight, itineraryList,
                    createNewTrip, switchTrip, deleteTrip, isRateLoading,
                    aiPlanDay, isAiPlanning, askAiAboutPlace
                };
            }
        }).mount('#app')
    </script>
</body>
</html>
