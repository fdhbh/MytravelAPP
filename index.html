<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—…éŠè¨ˆç•« | ç¥¨åˆ¸ç‰ˆv2.3</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* å¼·åˆ¶é–å®š Bodyï¼Œé˜²æ­¢ iOS éµç›¤å½ˆå‡ºæ™‚æ¨å‹•æ•´å€‹é é¢ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed; /* å›ºå®šå®šä½é˜²æ­¢æ•´é«”æ»¾å‹• */
            overflow: hidden;
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #F3F4F6;
            overscroll-behavior-y: none; /* é˜²æ­¢æ©¡çš®ç­‹æ•ˆæœ */
        }

        /* éš±è—æ»¾å‹•æ¢ */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å‹•ç•« */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in-up 0.4s ease-out forwards; }
        
        /* ç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
        .sync-status { position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-size: 12px; padding: 6px 12px; border-radius: 20px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; items-center; gap: 6px; font-weight: bold; transition: all 0.3s; }
        .sync-saving { color: #f59e0b; }
        .sync-saved { color: #10b981; }
        .sync-error { color: #ef4444; }

        /* æ‹–æ›³æ¨£å¼å„ªåŒ– */
        .sortable-ghost { opacity: 0.4; background: #f0f9ff; border: 2px dashed #3b82f6; }
        .sortable-fallback { opacity: 1 !important; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(1.02); } /* æ‹–æ›³æ™‚çš„æµ®å‹•å¡ç‰‡æ¨£å¼ */
        .drag-handle { touch-action: none; cursor: grab; -webkit-tap-highlight-color: transparent; } 
        .drag-handle:active { cursor: grabbing; }

        /* #app å®¹å™¨è¨­å®š */
        #app {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100dvh; /* ä½¿ç”¨å‹•æ…‹è¦–çª—é«˜åº¦ */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ç¢ºä¿åªæœ‰å…§éƒ¨ main å€åŸŸæ»¾å‹• */
        }
    </style>
</head>
<body class="text-slate-700">

    <div id="app" class="max-w-md mx-auto w-full bg-white shadow-2xl relative sm:rounded-xl sm:my-4 sm:h-[95vh] sm:border-4 sm:border-slate-100 sm:relative sm:top-auto sm:left-auto sm:right-auto sm:bottom-auto">

        <!-- ç‹€æ…‹æŒ‡ç¤ºç‡ˆ -->
        <div v-if="syncStatus" class="sync-status" :class="syncStatusClass">
            <i class="ph-bold" :class="syncStatusIcon"></i> {{ syncStatus }}
        </div>

        <!-- Header -->
        <header class="bg-teal-600 text-white shrink-0 z-20 shadow-md relative">
            <div class="p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <!-- åˆ†äº«æŒ‰éˆ• -->
                    <button @click="copyShareLink" class="text-teal-100 hover:text-white transition flex items-center gap-1 bg-teal-700/50 px-2 py-1 rounded-lg text-xs">
                        <i class="ph-bold ph-share-network"></i> åˆ†äº«
                    </button>
                    <div class="overflow-hidden">
                        <h1 class="text-xl font-bold tracking-wide flex items-center gap-2 truncate">
                            {{ setup.destination || 'æ—…éŠè¨ˆç•«' }} <i class="ph-fill ph-airplane-tilt text-sm opacity-70"></i>
                        </h1>
                    </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <!-- æ•´åˆæŒ‰éˆ•ç¾¤çµ„ -->
                    <div class="flex bg-teal-800/50 p-1 rounded-lg">
                        <button @click="viewMode = 'plan'" :class="viewMode === 'plan' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="p-2 rounded-md transition-all" title="è¡Œç¨‹"><i class="ph-bold ph-calendar-check text-lg"></i></button>
                        <button @click="viewMode = 'tickets'" :class="viewMode === 'tickets' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="p-2 rounded-md transition-all" title="ç¥¨åˆ¸"><i class="ph-bold ph-ticket text-lg"></i></button>
                        <button @click="viewMode = 'money'" :class="viewMode === 'money' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="p-2 rounded-md transition-all" title="åˆ†å¸³"><i class="ph-bold ph-currency-dollar text-lg"></i></button>
                        <button @click="viewMode = 'translate'" :class="viewMode === 'translate' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="p-2 rounded-md transition-all" title="ç¿»è­¯"><i class="ph-bold ph-translate text-lg"></i></button>
                    </div>
                </div>
            </div>
            <!-- ä¿®æ”¹è™•: åœ¨é»æ“Šæ—¥æœŸæ™‚ï¼ŒåŒæ™‚è¨­å®š viewMode = 'plan' -->
            <div class="flex overflow-x-auto hide-scroll px-2 pb-3 space-x-3 snap-x">
                <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index; viewMode = 'plan'" class="snap-center shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-xl cursor-pointer transition-all border-2" :class="currentDayIdx === index ? 'bg-white text-teal-600 border-white shadow-lg scale-105' : 'bg-teal-500/50 text-teal-100 border-transparent hover:bg-teal-500'">
                    <span class="text-[10px] font-bold opacity-90 mb-0.5">{{ day.shortDate }} ({{ getDayName(day.fullDate) }})</span>
                    <span class="text-lg font-bold leading-none">D{{ index + 1 }}</span>
                </div>
                <button @click="addDay" class="shrink-0 w-12 h-16 rounded-xl flex items-center justify-center border-2 border-teal-400 border-dashed text-teal-200 hover:text-white hover:border-white transition"><i class="ph-bold ph-plus"></i></button>
            </div>
        </header>

        <!-- Main Content (å”¯ä¸€å¯æ»¾å‹•å€åŸŸ) -->
        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll overscroll-none pb-safe">
            
            <!-- è¡Œç¨‹è¡¨ (Plan View) -->
            <transition name="fade" mode="out-in">
                <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 pb-24">
                    <!-- æ—¥æœŸæ¨™é¡Œå¡ -->
                    <div class="bg-white p-4 rounded-2xl shadow-sm mb-4 border border-slate-100 flex justify-between items-start sticky top-0 z-10">
                        <div class="flex-1 relative pt-0.5">
                            <input type="date" :value="currentDay.fullDate" @change="updateDate($event, currentDay)" class="absolute top-0 left-0 w-40 h-8 opacity-0 z-20 cursor-pointer">
                            <input v-model="currentDay.date" class="text-xl font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0 w-full relative z-10 pointer-events-none" placeholder="Day 1 (é»æ“Šè¨­å®š)">
                            <input v-model="currentDay.title" class="text-sm text-slate-500 bg-transparent border-b border-dashed border-slate-300 focus:border-teal-500 focus:outline-none w-full mt-1" placeholder="è¼¸å…¥ç•¶æ—¥ä¸»é¡Œ">
                        </div>
                        <div class="flex flex-col items-end pl-2">
                            <div v-if="weatherDisplay" class="text-right">
                                <div class="flex items-center justify-end gap-1 text-indigo-600">
                                    <i :class="['ph-duotone', weatherDisplay.icon, 'text-2xl']"></i>
                                    <span class="text-xl font-bold font-mono whitespace-nowrap">{{ weatherDisplay.temp }}</span>
                                </div>
                                <div class="text-[10px] text-slate-400 flex items-center gap-1 justify-end mt-0.5">
                                    <i :class="weatherDisplay.isForecast ? 'ph-bold ph-calendar' : 'ph-bold ph-map-pin'"></i>
                                    {{ weatherDisplay.label }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- èˆªç­å¡ç‰‡ -->
                    <div class="mb-6">
                        <div v-if="currentDay.flight" class="relative bg-gradient-to-r from-blue-600 to-teal-500 rounded-2xl text-white shadow-lg overflow-hidden">
                            <div class="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-50 rounded-full z-10"></div>
                            <div class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-50 rounded-full z-10"></div>
                            <div class="p-4 relative z-0">
                                <button @click="toggleFlightCard" class="absolute top-2 right-2 text-white/50 hover:text-white hover:bg-white/20 rounded-full p-1 transition"><i class="ph-bold ph-x"></i></button>
                                <div class="flex justify-between items-center mb-1 pt-2">
                                    <!-- å‡ºç™¼ -->
                                    <div class="flex flex-col items-center w-1/3">
                                        <input v-model="currentDay.flight.startTime" type="time" class="text-2xl font-black bg-transparent border-b border-white/30 w-full text-center text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0">
                                        <div class="text-[9px] opacity-60 mt-1">èµ·é£› (ç•¶åœ°æ™‚é–“)</div>
                                        <input v-model="currentDay.flight.startAirport" class="text-sm font-bold opacity-90 bg-transparent border-none text-center w-full text-teal-100 placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="TPE">
                                    </div>
                                    <!-- è³‡è¨Š -->
                                    <div class="flex flex-col items-center justify-center w-1/3 px-2">
                                        <i class="ph-fill ph-airplane text-2xl mb-1 transform rotate-90"></i>
                                        <input v-model="currentDay.flight.number" class="text-[10px] font-mono tracking-widest opacity-80 bg-transparent border-none text-center w-full text-white placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="BR198">
                                        <div class="w-full h-0.5 bg-white/30 rounded-full mt-1"></div>
                                    </div>
                                    <!-- æŠµé” -->
                                    <div class="flex flex-col items-center w-1/3">
                                        <input v-model="currentDay.flight.endTime" type="time" class="text-2xl font-black bg-transparent border-b border-white/30 w-full text-center text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0">
                                        <div class="relative w-full mt-0.5">
                                            <select v-model="currentDay.flight.arrivalOffset" class="appearance-none bg-black/20 text-white text-[9px] rounded border-none w-full py-0.5 px-1 text-center focus:ring-0 cursor-pointer hover:bg-black/30">
                                                <option value="0" class="text-slate-800">åŒæ—¥æŠµé”</option>
                                                <option value="1" class="text-slate-800">+1å¤© (éš”æ—¥)</option>
                                                <option value="-1" class="text-slate-800">-1å¤© (å‰æ—¥)</option>
                                            </select>
                                            <div v-if="currentDay.flight.arrivalOffset != 0" class="absolute -top-8 right-0 bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded shadow font-bold animate-pulse">
                                                {{ currentDay.flight.arrivalOffset > 0 ? '+1' : '-1' }}
                                            </div>
                                        </div>
                                        <input v-model="currentDay.flight.endAirport" class="text-sm font-bold opacity-90 bg-transparent border-none text-center w-full text-teal-100 placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="NRT">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button v-else @click="toggleFlightCard" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 hover:border-teal-400 hover:text-teal-500 hover:bg-teal-50/50 transition flex items-center justify-center gap-2 group">
                            <i class="ph-bold ph-airplane-tilt text-lg group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-bold">æ–°å¢ç•¶æ—¥èˆªç­è³‡è¨Š</span>
                        </button>
                    </div>

                    <div class="relative pl-4 border-l-2 border-teal-100">
                        <div ref="itineraryList" class="space-y-6 pb-8">
                            <div v-for="(item, idx) in currentDay.items" :key="item.id" class="relative group cursor-default">
                                <div class="absolute -left-[21px] top-3 w-3 h-3 rounded-full border-2 border-white shadow-sm" :class="getDotColor(item.type)"></div>
                                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                                    <div class="flex flex-col gap-2">
                                        <div class="flex items-start gap-3">
                                            <!-- æ‹–æ›³æ‰‹æŸ„ (å€åŸŸå„ªåŒ–) -->
                                            <div class="drag-handle cursor-grab text-slate-300 hover:text-teal-500 self-center -ml-1 py-3 px-1 touch-none">
                                                <i class="ph-bold ph-dots-six-vertical text-2xl"></i>
                                            </div>
                                            <div class="flex flex-col items-center w-20 shrink-0 gap-2">
                                                <div class="relative flex flex-col items-center justify-center bg-slate-50 border border-slate-200 rounded-xl p-1 w-full h-16 cursor-pointer hover:bg-teal-50 hover:border-teal-200 transition group/time">
                                                    <span class="text-[10px] font-medium text-slate-400 group-hover/time:text-teal-400">{{ getTimePeriod(item.time) }}</span>
                                                    <span class="text-xl font-bold text-slate-700 group-hover/time:text-teal-600 leading-none font-mono tracking-tight">{{ item.time || '--:--' }}</span>
                                                    <input v-model="item.time" type="time" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" @click="$event.target.showPicker ? $event.target.showPicker() : null">
                                                </div>
                                                <select v-model="item.type" class="text-[10px] bg-white border border-slate-200 rounded-md py-1 px-1 w-full text-center">
                                                    <option value="spot">ğŸ“ æ™¯é»</option>
                                                    <option value="food">ğŸ´ ç¾é£Ÿ</option>
                                                    <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                                    <option value="transport">ğŸš‡ äº¤é€š</option>
                                                    <option value="flight">âœˆï¸ èˆªç­</option>
                                                    <option value="hotel">ğŸ¨ ä½å®¿</option>
                                                </select>
                                            </div>
                                            <div class="flex-1 min-w-0 pt-1">
                                                <input v-model="item.activity" class="block w-full font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0" placeholder="è¡Œç¨‹åç¨±...">
                                                <div class="flex items-center gap-1 mt-1">
                                                    <i class="ph-fill ph-map-pin text-teal-400 text-xs"></i>
                                                    <input v-model="item.location" class="flex-1 text-xs text-slate-500 bg-transparent border-none p-0 focus:ring-0 truncate" placeholder="è¼¸å…¥åœ°é» (ä¾‹å¦‚: æ–°å®¿)">
                                                </div>
                                                <!-- å‚™è¨»å€å¡Š -->
                                                <div class="mt-2 relative">
                                                    <div class="flex items-start gap-2 bg-slate-50 rounded-lg p-2 border border-slate-100 group-focus-within:border-teal-200 group-focus-within:bg-white transition-colors">
                                                        <i class="ph-bold ph-notebook text-slate-400 text-sm mt-0.5 shrink-0"></i>
                                                        <textarea 
                                                            v-model="item.note" 
                                                            class="auto-resize-textarea w-full text-xs text-slate-600 bg-transparent border-none p-0 focus:ring-0 leading-relaxed resize-none placeholder-slate-400 min-h-[20px]" 
                                                            placeholder="æ·»åŠ å‚™è¨»ã€ç´°ç¯€ã€é ç´„è™Ÿç¢¼..." 
                                                            rows="1"
                                                            @input="adjustHeight($event.target)"
                                                            @focus="adjustHeight($event.target)"
                                                        ></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex flex-col gap-2 items-center">
                                                <a :href="getGoogleMapLink(item.location)" target="_blank" class="text-teal-500 hover:bg-teal-50 p-1 rounded" title="Google Map"><i class="ph-bold ph-navigation-arrow"></i></a>
                                                <button @click="removeItem(idx)" class="text-red-300 hover:text-red-500 p-1 rounded"><i class="ph-bold ph-trash"></i></button>
                                            </div>
                                        </div>
                                        
                                        <!-- QRCODE é€£çµ -->
                                        <div class="mt-2 pt-2 border-t border-slate-100 flex items-center gap-2">
                                            <div class="relative flex-1">
                                                <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                                                    <i class="ph-bold ph-qr-code text-slate-400"></i>
                                                </div>
                                                <input v-model="item.qrcode" class="block w-full pl-8 pr-2 py-1 text-xs bg-slate-50 border border-slate-200 rounded-lg focus:ring-1 focus:ring-teal-500 focus:border-teal-500" placeholder="è²¼ä¸Šç¥¨åˆ¸ QR Code é€£çµ...">
                                            </div>
                                            <a v-if="item.qrcode" :href="item.qrcode" target="_blank" class="shrink-0 bg-slate-800 text-white text-xs px-3 py-1.5 rounded-lg hover:bg-slate-700 flex items-center gap-1 shadow-sm">
                                                <i class="ph-bold ph-link"></i> é–‹å•Ÿ
                                            </a>
                                        </div>

                                        <!-- æ™ºæ…§æ¨è–¦å€ -->
                                        <div v-if="item.type === 'food'" class="p-2 bg-orange-50 rounded-lg border border-orange-100/50 mt-1">
                                            <div class="flex items-center justify-between mb-1">
                                                <p class="text-[10px] font-bold text-orange-400 flex items-center gap-1">
                                                    <i class="ph-fill ph-fork-knife"></i> ç¾é£Ÿæ¨è–¦
                                                </p>
                                                <button @click="searchNearby(item, idx)" class="text-[10px] text-teal-600 hover:text-teal-800 flex items-center gap-1 bg-white px-2 py-0.5 rounded border border-teal-100 shadow-sm" :disabled="!item.location">
                                                    <i v-if="isSearchingRecs && searchTargetIndex === `${currentDayIdx}-${idx}`" class="ph-bold ph-spinner animate-spin"></i>
                                                    <i v-else class="ph-bold ph-magnifying-glass"></i>
                                                    æœå°‹
                                                </button>
                                            </div>
                                            <div v-if="recommendationsMap[`${currentDayIdx}-${idx}`] && recommendationsMap[`${currentDayIdx}-${idx}`].length > 0" class="flex flex-wrap gap-2 mt-1">
                                                <button v-for="rec in recommendationsMap[`${currentDayIdx}-${idx}`]" :key="rec.name" @click="applyRecommendation(item, rec)" class="text-[10px] px-2 py-1.5 bg-white border border-orange-200 rounded-lg text-slate-600 hover:bg-orange-500 hover:text-white hover:border-orange-500 transition shadow-sm flex flex-col items-start gap-0.5 max-w-[120px] truncate">
                                                    <span class="font-bold truncate w-full text-left">{{ rec.name }}</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                             <button @click="addItem" class="flex-1 flex items-center justify-center gap-2 text-teal-500 hover:text-teal-700 text-sm font-medium px-4 py-3 bg-white border border-dashed border-teal-300 rounded-xl hover:bg-teal-50 transition shadow-sm">
                                <div class="w-2 h-2 bg-teal-300 rounded-full"></div><i class="ph-bold ph-plus"></i> æ–°å¢è¡Œç¨‹
                            </button>
                        </div>

                    </div>
                    <div class="mt-12 pt-6 border-t border-slate-200 text-center">
                        <button @click="removeCurrentDay" class="text-xs text-red-300 hover:text-red-500 flex items-center justify-center gap-1 mx-auto"><i class="ph-bold ph-trash"></i> åˆªé™¤é€™ä¸€å¤©</button>
                    </div>
                </div>
            </transition>

            <!-- ç¥¨åˆ¸è¦–åœ– -->
            <div v-if="viewMode === 'tickets'" class="p-4 pb-24 h-full flex flex-col">
                <div class="mb-4 bg-gradient-to-r from-teal-500 to-emerald-600 rounded-2xl p-6 text-white shadow-lg">
                    <h2 class="text-xl font-bold flex items-center gap-2"><i class="ph-bold ph-ticket"></i> æˆ‘çš„ç¥¨åˆ¸å¤¾</h2>
                    <p class="text-teal-100 text-xs mt-1">é›†ä¸­ç®¡ç†æ‰€æœ‰é ç´„è­‰æ˜ã€é–€ç¥¨ QR Code</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-slate-100">
                    <h3 class="text-xs font-bold text-slate-400 mb-2 uppercase">æ–°å¢ç¥¨åˆ¸</h3>
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <input v-model="newTicket.date" type="date" class="bg-slate-50 border-none rounded-lg text-sm px-3 py-2 w-1/3 text-slate-600">
                            <input v-model="newTicket.name" placeholder="ç¥¨åˆ¸åç¨± (ä¾‹: è¿ªå£«å°¼é–€ç¥¨)" class="bg-slate-50 border-none rounded-lg text-sm px-3 py-2 flex-1 min-w-0">
                        </div>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                                    <i class="ph-bold ph-link text-slate-400"></i>
                                </div>
                                <input v-model="newTicket.link" placeholder="QR Code åœ–ç‰‡é€£çµæˆ–ç¶²å€..." class="w-full pl-8 pr-2 py-2 text-sm bg-slate-50 border-none rounded-lg">
                            </div>
                            <button @click="addTicket" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold shadow-sm whitespace-nowrap">æ–°å¢</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-3 flex-1 overflow-y-auto hide-scroll pb-20">
                    <div v-if="tickets.length === 0" class="text-center py-10 text-slate-300">
                        <i class="ph-duotone ph-ticket text-4xl mb-2"></i>
                        <p class="text-sm">é‚„æ²’æœ‰ç¥¨åˆ¸ï¼Œå¿«é»æ–°å¢å§ï¼</p>
                    </div>
                    <div v-for="(ticket, idx) in sortedTickets" :key="ticket.id" class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden group">
                        <div class="p-4 flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-teal-50 text-teal-700 text-[10px] font-bold px-2 py-0.5 rounded border border-teal-100">{{ ticket.date || 'ç„¡æ—¥æœŸ' }}</span>
                                </div>
                                <h3 class="text-lg font-bold text-slate-800">{{ ticket.name }}</h3>
                                <a v-if="ticket.link" :href="ticket.link" target="_blank" class="text-xs text-blue-500 hover:underline mt-1 inline-block truncate max-w-[200px]"><i class="ph-bold ph-link"></i> {{ ticket.link }}</a>
                            </div>
                            <button @click="removeTicket(ticket.id)" class="text-slate-300 hover:text-red-500 p-2"><i class="ph-bold ph-trash"></i></button>
                        </div>
                        <a v-if="ticket.link" :href="ticket.link" target="_blank" class="block bg-slate-50 p-3 text-center text-slate-600 hover:bg-slate-100 border-t border-slate-100 transition">
                            <i class="ph-bold ph-qr-code text-xl mb-1 block"></i>
                            <span class="text-xs font-bold">é–‹å•Ÿ QR Code</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- åˆ†å¸³è¦–åœ– -->
            <div v-if="viewMode === 'money'" class="p-4 pb-24">
                <div class="bg-teal-600 text-white rounded-2xl p-6 shadow-lg mb-6 text-center relative">
                    <div class="absolute top-4 right-4 flex flex-col items-end">
                        <label class="text-[10px] text-teal-200 mb-1">åŒ¯ç‡ ({{ currencyLabel }})</label>
                        <input v-model.number="exchangeRate" type="number" step="0.001" class="w-16 text-right text-xs text-teal-900 rounded px-1 py-0.5">
                    </div>
                    <div class="text-sm opacity-80 mb-1">ç¸½æ”¯å‡º Total</div>
                    <div class="text-4xl font-bold font-mono">{{ currencySymbol }} {{ totalExpense.toLocaleString() }}</div>
                    <div class="text-lg font-bold text-teal-200 mt-1">â‰ˆ NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}</div>
                </div>
                <div class="mb-4 bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                    <div class="text-xs font-bold text-slate-400 mb-2">åˆ†å¸³æˆå“¡ (ç”¨é€—è™Ÿåˆ†éš”)</div>
                    <input v-model="participantsStr" @change="updateParticipants" class="w-full text-sm bg-slate-50 rounded px-2 py-1 border border-slate-200" placeholder="ä¾‹å¦‚: æˆ‘, æœ‹å‹A, æœ‹å‹B">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <div v-for="p in participants" :key="p" class="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                        <div class="text-xs text-slate-400 mb-1">{{ p }} å¢Šä»˜</div>
                        <div class="text-sm font-bold text-teal-600">{{ currencySymbol }}{{ paidByPerson[p]?.toLocaleString() || 0 }}</div>
                    </div>
                </div>
                <div v-if="settlementPlan.length > 0" class="bg-teal-50 rounded-xl p-4 mb-6 border border-teal-100">
                    <h3 class="text-xs font-bold text-teal-400 uppercase tracking-wide mb-3">çµå¸³å»ºè­°</h3>
                    <div class="space-y-2">
                        <div v-for="(plan, idx) in settlementPlan" :key="idx" class="flex items-center justify-between text-sm bg-white p-2 rounded-lg shadow-sm">
                            <span class="font-bold text-slate-600">{{ plan.from }} <i class="ph-bold ph-arrow-right text-xs"></i> {{ plan.to }}</span>
                            <span class="font-mono font-bold text-teal-600">{{ currencySymbol }}{{ plan.amount.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-slate-100">
                    <div class="flex gap-2 mb-2">
                        <input v-model="newExpense.item" placeholder="é …ç›®" class="w-[65%] bg-slate-50 border-none rounded-lg text-sm px-3 py-2">
                        <select v-model="newExpense.payer" class="flex-1 bg-slate-50 border-none rounded-lg text-sm px-2 py-2 min-w-0">
                            <option v-for="p in participants" :value="p">{{ p }}</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input v-model.number="newExpense.amount" type="number" :placeholder="currencySymbol + ' é‡‘é¡'" class="w-full bg-slate-50 border-none rounded-lg text-sm pl-3 pr-3 py-2 font-mono">
                        <button @click="addExpense" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold"><i class="ph-bold ph-plus"></i></button>
                    </div>
                </div>
                <div class="space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 text-xs font-bold">{{ exp.payer.charAt(0) }}</div>
                            <div><div class="font-bold text-slate-700 text-sm">{{ exp.item }}</div></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-bold text-slate-700">{{ currencySymbol }}{{ exp.amount.toLocaleString() }}</span>
                            <button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400"><i class="ph-fill ph-x-circle"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¿»è­¯åŠŸèƒ½ -->
            <div v-if="viewMode === 'translate'" class="p-6 h-full flex flex-col justify-center items-center pb-32">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Google ç¿»è­¯æ·å¾‘</h2>
                    <p class="text-sm text-slate-400">è«‹é¸æ“‡æ‚¨éœ€è¦çš„ç¿»è­¯æ¨¡å¼</p>
                </div>
                <div class="w-full mb-4">
                    <a href="https://translate.google.com/?op=images" target="_blank" class="block w-full">
                        <button class="w-full bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left"><div class="text-xs opacity-80 mb-1 tracking-wider">èœå–® / çœ‹æ¿</div><div class="text-2xl font-bold">ç…§ç›¸ç¿»è­¯ <i class="ph-bold ph-camera text-sm"></i></div></div>
                                <i class="ph-duotone ph-camera-plus text-3xl opacity-60 group-hover:opacity-100"></i>
                            </div>
                        </button>
                    </a>
                </div>
                <div class="w-full mb-4">
                    <a :href="`https://translate.google.com/?sl=zh-TW&tl=${setup.langCode}&op=translate`" target="_blank" class="block w-full">
                        <button class="w-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left"><div class="text-xs opacity-80 mb-1 tracking-wider">æˆ‘èªªä¸­æ–‡ (è½‰{{ setup.langName }})</div><div class="text-2xl font-bold">CH <i class="ph-bold ph-arrow-right text-sm"></i> {{ setup.langCode.toUpperCase() }}</div></div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl opacity-60 group-hover:opacity-100"></i>
                            </div>
                        </button>
                    </a>
                </div>
                <div class="w-full">
                    <a :href="`https://translate.google.com/?sl=${setup.langCode}&tl=zh-TW&op=translate`" target="_blank" class="block w-full">
                        <button class="w-full bg-white border-2 border-slate-200 text-slate-700 rounded-2xl p-6 shadow-sm active:scale-95 transition-transform relative overflow-hidden group hover:border-indigo-300">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left"><div class="text-xs text-slate-400 mb-1 tracking-wider">å°æ–¹èªª{{ setup.langName }} (è½‰ä¸­æ–‡)</div><div class="text-2xl font-bold font-jp">{{ setup.langCode.toUpperCase() }} <i class="ph-bold ph-arrow-right text-sm"></i> CH</div></div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                            </div>
                        </button>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- åˆå§‹è¨­å®šè¦–çª— -->
        <div v-if="showSetupModal" class="absolute inset-0 bg-teal-800/90 backdrop-blur-sm z-50 flex items-center justify-center p-6 animate-fade-in">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-3"><i class="ph-duotone ph-airplane-tilt text-3xl text-teal-600"></i></div>
                    <h2 class="text-2xl font-bold text-slate-800">å»ºç«‹æ–°æ—…ç¨‹ (å¤šäººç‰ˆ)</h2>
                    <p class="text-sm text-slate-400">å»ºç«‹å¾Œï¼Œå°‡ç¶²å€å‚³çµ¦æœ‹å‹å³å¯åŒæ­¥ï¼</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ç›®çš„åœ° (è‹±æ–‡/ä¸­æ–‡)</label>
                        <div class="relative">
                            <input v-model="setup.destination" @blur="detectRate" type="text" placeholder="ä¾‹å¦‚: Tokyo, Osaka" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-teal-500 font-bold">
                            <button @click="detectRate" class="absolute right-3 top-3 text-teal-500 hover:text-teal-700"><i class="ph-bold ph-magnifying-glass"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">é–‹å§‹æ—¥æœŸ</label>
                            <input v-model="setup.startDate" type="date" class="h-12 w-full bg-slate-50 border border-slate-200 rounded-xl px-3 text-slate-700 focus:ring-2 focus:ring-teal-500 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">å¤©æ•¸</label>
                            <input v-model.number="setup.days" type="number" min="1" max="30" class="h-12 w-full bg-slate-50 border border-slate-200 rounded-xl px-3 text-slate-700 focus:ring-2 focus:ring-teal-500 text-center font-bold">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1 flex justify-between"><span>åŒ¯ç‡ ({{ setup.currency || 'å¤–å¹£' }}:å°å¹£)</span><span v-if="isRateLoading" class="text-teal-500 animate-pulse">æŠ“å–ä¸­...</span></label>
                        <input v-model.number="setup.rate" type="number" step="0.001" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-teal-500 font-mono text-right">
                    </div>
                    <button @click="initTrip" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3.5 rounded-xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-2 mt-2">é–‹å§‹è¦åŠƒ <i class="ph-bold ph-arrow-right"></i></button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // --- FIREBASE è¨­å®šå€ (è«‹å¡«å…¥ä½ çš„è¨­å®š) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBHBeNkqkVoRl4E7FAcEPI-c2M-0ffSFPM",
            authDomain: "mytravelapp-f9c1c.firebaseapp.com",
            projectId: "mytravelapp-f9c1c",
            storageBucket: "mytravelapp-f9c1c.firebasestorage.app",
            messagingSenderId: "1024870317388",
            appId: "1:1024870317388:web:772e1a90d888ab2107a3e9"
        };
        // ------------------------------------

        // åˆå§‹åŒ– Firebase
        let appInstance, db;
        try {
            appInstance = initializeApp(firebaseConfig);
            db = getFirestore(appInstance);
            console.log("Firebase initialized");
        } catch(e) { console.error(e); }

        // é˜²æŠ–å‹•å‡½æ•¸ (é¿å…éæ–¼é »ç¹å¯«å…¥è³‡æ–™åº«)
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        const app = createApp({
            setup() {
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const showSetupModal = ref(false);
                const itineraryList = ref(null); // ç”¨æ–¼ç¶å®šæ‹–æ›³å®¹å™¨

                // è³‡æ–™èˆ‡ç‹€æ…‹
                const days = ref([]);
                const expenses = ref([]);
                const tickets = ref([]); // æ–°å¢: ç¥¨åˆ¸è³‡æ–™
                const newTicket = ref({ date: '', name: '', link: '' }); // æ–°å¢: æ–°ç¥¨åˆ¸è¼¸å…¥

                const participants = ref(['æˆ‘', 'æ—…ä¼´A']);
                const participantsStr = ref('æˆ‘, æ—…ä¼´A');
                const exchangeRate = ref(0.215);
                const newExpense = ref({ item: '', amount: '', payer: 'æˆ‘' });
                const tripId = ref(null);

                // ç³»çµ±ç‹€æ…‹
                const isRateLoading = ref(false);
                const weather = ref({ temp: null, icon: 'ph-sun', code: 0, location: '', daily: [] });
                const setup = ref({ destination: 'Tokyo', startDate: new Date().toISOString().split('T')[0], days: 5, rate: 0.215, currency: 'JPY', langCode: 'ja', langName: 'æ—¥æ–‡' });
                
                // åŒæ­¥ç‹€æ…‹
                const syncStatus = ref(''); // '', 'å·²å„²å­˜', 'å„²å­˜ä¸­...', 'é€£ç·šéŒ¯èª¤'
                let isRemoteUpdate = false; // æ——æ¨™ï¼šåˆ†è¾¨æ˜¯å¦ç‚ºé ç«¯æ›´æ–°

                // æ™ºæ…§æ¨è–¦
                const recommendationsMap = reactive({});
                const isSearchingRecs = ref(false);
                const searchTargetIndex = ref('');

                let sortableInstance = null;

                // --- Computed ---
                const currentDay = computed(() => days.value[currentDayIdx.value] || {items:[], flight:null, date:'', title:''});
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                
                // æ–°å¢: æ’åºå¾Œçš„ç¥¨åˆ¸ (ä¾æ—¥æœŸ)
                const sortedTickets = computed(() => {
                    return [...tickets.value].sort((a, b) => {
                        if (!a.date) return 1;
                        if (!b.date) return -1;
                        return new Date(a.date) - new Date(b.date);
                    });
                });

                const paidByPerson = computed(() => {
                    const map = {};
                    participants.value.forEach(p => map[p] = 0);
                    expenses.value.forEach(e => { if (map[e.payer] === undefined) map[e.payer] = 0; map[e.payer] += e.amount; });
                    return map;
                });
                const settlementPlan = computed(() => {
                    if (totalExpense.value === 0) return [];
                    const average = totalExpense.value / participants.value.length;
                    let balances = participants.value.map(p => ({ name: p, val: (paidByPerson.value[p] || 0) - average }));
                    let debtors = balances.filter(b => b.val < -1).sort((a, b) => a.val - b.val);
                    let creditors = balances.filter(b => b.val > 1).sort((a, b) => b.val - a.val);
                    const result = [];
                    let i = 0; let j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let debtor = debtors[i];
                        let creditor = creditors[j];
                        let amount = Math.min(Math.abs(debtor.val), creditor.val);
                        amount = Math.round(amount);
                        if (amount > 0) result.push({ from: debtor.name, to: creditor.name, amount: amount });
                        debtor.val += amount; creditor.val -= amount;
                        if (Math.abs(debtor.val) < 1) i++;
                        if (creditor.val < 1) j++;
                    }
                    return result;
                });
                const currencyLabel = computed(() => setup.value.currency || 'å¤–å¹£');
                const currencySymbol = computed(() => {
                    const map = { 'JPY': 'Â¥', 'CNY': 'Â¥', 'USD': '$', 'EUR': 'â‚¬', 'KRW': 'â‚©', 'GBP': 'Â£', 'TWD': 'NT$', 'HKD': 'HK$', 'THB': 'à¸¿', 'VND': 'â‚«' };
                    return map[setup.value.currency] || '$';
                });
                const weatherDisplay = computed(() => {
                    if (!currentDay.value || !currentDay.value.fullDate || weather.value.daily.length === 0) {
                        return { temp: weather.value.temp !== null ? `${weather.value.temp}Â°` : '--', icon: weather.value.icon || 'ph-sun', label: `${setup.value.destination || 'ç•¶åœ°'} (ç›®å‰)`, isForecast: false };
                    }
                    const targetDate = currentDay.value.fullDate;
                    const idx = weather.value.daily.time.indexOf(targetDate);
                    if (idx !== -1) {
                        const max = Math.round(weather.value.daily.temperature_2m_max[idx]);
                        const min = Math.round(weather.value.daily.temperature_2m_min[idx]);
                        return { temp: `${min}Â° - ${max}Â°`, icon: getWeatherIcon(weather.value.daily.weathercode[idx]), label: `${setup.value.destination} (é å ±)`, isForecast: true };
                    }
                    return { temp: weather.value.temp !== null ? `${weather.value.temp}Â°` : '--', icon: weather.value.icon || 'ph-sun', label: `${setup.value.destination} (ç›®å‰)`, isForecast: false };
                });
                const syncStatusClass = computed(() => {
                    if(syncStatus.value === 'å„²å­˜ä¸­...') return 'sync-saving';
                    if(syncStatus.value === 'å·²åŒæ­¥') return 'sync-saved';
                    return 'sync-error';
                });
                const syncStatusIcon = computed(() => {
                    if(syncStatus.value === 'å„²å­˜ä¸­...') return 'ph-spinner animate-spin';
                    if(syncStatus.value === 'å·²åŒæ­¥') return 'ph-check-circle';
                    return 'ph-warning';
                });
                // æ–°å¢: åˆ¤æ–·æ˜¯å¦ç‚ºéŸ“åœ‹è¡Œç¨‹
                const isKoreaTrip = computed(() => {
                    return setup.value.langCode === 'ko' || setup.value.currency === 'KRW';
                });

                // --- Helpers ---
                const generateId = () => 'trip_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                const getWeatherIcon = (c) => { if (c===0) return 'ph-sun'; if (c<4) return 'ph-cloud-sun'; if (c<50) return 'ph-cloud-fog'; if (c<70) return 'ph-cloud-rain'; return 'ph-cloud'; };
                const getTimePeriod = (t) => { if(!t) return 'æ™‚é–“'; const h=parseInt(t.split(':')[0]); return h<5?'å‡Œæ™¨':h<11?'ä¸Šåˆ':h<14?'ä¸­åˆ':h<18?'ä¸‹åˆ':'æ™šä¸Š'; };
                const toggleFlightCard = () => {
                     if (currentDay.value.flight) { if(confirm('ç§»é™¤èˆªç­?')) currentDay.value.flight = null; }
                     else { currentDay.value.flight = { type: 'arrival', startTime: '10:00', startAirport: 'TPE', number: 'FLIGHT', endTime: '14:00', endAirport: 'DEST', arrivalOffset: 0 }; }
                };
                const getDotColor = (t) => t==='food'?'bg-orange-400':t==='shop'?'bg-pink-400':t==='flight'?'bg-blue-500':t==='hotel'?'bg-indigo-500':'bg-teal-500';
                const updateParticipants = () => { participants.value = participantsStr.value.split(',').map(s=>s.trim()).filter(s=>s); };
                const updateDate = (e, day) => {
                    const val = e.target.value; if(!val) return;
                    day.fullDate = val;
                    const d = new Date(val);
                    if(isNaN(d.getTime())) return;
                    const w = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
                    const mm = d.getMonth()+1; const dd = d.getDate();
                    day.date = `${mm < 10 ? '0'+mm : mm}/${dd < 10 ? '0'+dd : dd} (${w})`;
                    day.shortDate = `${mm}/${dd}`;
                };
                
                const getDayName = (dateStr) => {
                    if (!dateStr) return '';
                    const parts = dateStr.split('-');
                    const d = new Date(parts[0], parts[1] - 1, parts[2]); 
                    const map = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    return map[d.getDay()] || '';
                }

                // --- Auto Resize Function ---
                const adjustHeight = (el) => {
                    if (!el) return;
                    el.style.height = 'auto'; 
                    el.style.height = (el.scrollHeight) + 'px';
                };

                const resizeAllTextareas = async () => {
                    await nextTick();
                    const textareas = document.querySelectorAll('.auto-resize-textarea');
                    textareas.forEach(adjustHeight);
                };

                watch(() => currentDay.value, resizeAllTextareas, { deep: true, immediate: true });

                // --- Sortable Init Logic ---
                const initSortable = () => {
                    if (sortableInstance) sortableInstance.destroy();
                    if (!itineraryList.value) return;
                    
                    sortableInstance = new Sortable(itineraryList.value, {
                        group: 'shared',
                        animation: 200,
                        handle: '.drag-handle', // æŒ‡å®šæ‹–æ›³æ‰‹æŸ„
                        ghostClass: 'sortable-ghost',
                        fallbackClass: 'sortable-fallback', // æ‹–æ›³æ™‚çš„æ¨£å¼
                        forceFallback: true, // [é—œéµä¿®æ­£] å¼·åˆ¶ä½¿ç”¨ JS æ¨¡æ“¬æ‹–æ›³ï¼Œè§£æ±ºéƒ¨åˆ†æ‰‹æ©ŸåŸç”Ÿæ‹–æ›³ API ä¸ç›¸å®¹å•é¡Œ
                        fallbackTolerance: 3, // éœ€ç§»å‹• 3px æ‰è¦–ç‚ºæ‹–æ›³ï¼Œé¿å…èª¤è§¸é»æ“Š
                        scroll: true, // å…è¨±æ‹–æ›³åˆ°é‚Šç·£æ™‚æ»¾å‹•
                        scrollSensitivity: 80, // æ¥è¿‘é‚Šç·£å¤šå°‘ px é–‹å§‹æ»¾å‹•
                        scrollSpeed: 10,
                        onEnd: (evt) => {
                            // æ›´æ–° Vue è³‡æ–™é™£åˆ—ä»¥ç¬¦åˆæ–°çš„ DOM é †åº
                            const item = currentDay.value.items.splice(evt.oldIndex, 1)[0];
                            currentDay.value.items.splice(evt.newIndex, 0, item);
                        }
                    });
                };

                // ç•¶åˆ‡æ›åˆ°è¡Œç¨‹é é¢æˆ–åˆ‡æ›å¤©æ•¸æ™‚ï¼Œé‡æ–°åˆå§‹åŒ–æ‹–æ›³åŠŸèƒ½
                watch([viewMode, currentDayIdx], async () => {
                    if (viewMode.value === 'plan') {
                        await nextTick();
                        initSortable();
                    }
                });

                // --- Core Actions ---
                const addItem = () => {
                    // æ–°å¢é …ç›®æ™‚çµ¦äºˆä¸€å€‹å”¯ä¸€çš„ ID
                    currentDay.value.items.push({ 
                        id: Date.now() + Math.random(), 
                        time: '', type: 'spot', activity: '', location: '', note: '', qrcode: '' // æ–°å¢ qrcode æ¬„ä½
                    });
                };
                const removeItem = (idx) => currentDay.value.items.splice(idx, 1);
                const addDay = () => days.value.push({ date: `Day ${days.value.length+1}`, title: '', items: [] });
                const removeCurrentDay = () => { if(days.value.length>1 && confirm('åˆªé™¤?')) days.value.splice(currentDayIdx.value, 1); };
                const getGoogleMapLink = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';
                const getNaverMapLink = (loc) => loc ? `https://map.naver.com/p/search/${encodeURIComponent(loc)}` : '#';

                const addExpense = () => { if(newExpense.value.item) { expenses.value.unshift({...newExpense.value}); newExpense.value.item=''; newExpense.value.amount=''; }};
                const removeExpense = (idx) => expenses.value.splice(idx, 1);
                
                // æ–°å¢: ç¥¨åˆ¸æ“ä½œ
                const addTicket = () => {
                    if (newTicket.value.name) {
                        tickets.value.push({
                            id: Date.now(),
                            date: newTicket.value.date,
                            name: newTicket.value.name,
                            link: newTicket.value.link
                        });
                        newTicket.value = { date: '', name: '', link: '' };
                    } else {
                        alert('è«‹è¼¸å…¥ç¥¨åˆ¸åç¨±');
                    }
                };
                const removeTicket = (id) => {
                    const idx = tickets.value.findIndex(t => t.id === id);
                    if(idx !== -1 && confirm('ç¢ºå®šåˆªé™¤æ­¤ç¥¨åˆ¸?')) tickets.value.splice(idx, 1);
                };

                // --- Share ---
                const copyShareLink = () => {
                    const url = window.location.href;
                    navigator.clipboard.writeText(url).then(() => alert('é€£çµå·²è¤‡è£½ï¼å‚³çµ¦æœ‹å‹å³å¯å…±åŒç·¨è¼¯ã€‚'));
                };

                // --- LBS æ¨è–¦åŠŸèƒ½ ---
                const searchNearby = async (item, idx) => {
                    if (!item.location || item.type !== 'food') return;
                    const key = `${currentDayIdx.value}-${idx}`;
                    searchTargetIndex.value = key;
                    isSearchingRecs.value = true;
                    recommendationsMap[key] = []; 
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}&limit=1`);
                        const geoData = await geoRes.json();
                        if (geoData && geoData.length > 0) {
                            const lat = geoData[0].lat;
                            const lon = geoData[0].lon;
                            const searchRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=restaurant near ${item.location}&limit=4`);
                            const searchData = await searchRes.json();
                            recommendationsMap[key] = searchData.map(place => ({
                                name: place.name || place.display_name.split(',')[0], 
                                location: place.name || place.display_name.split(',')[0],
                                note: 'æ¨è–¦åœ°é»'
                            }));
                            if (recommendationsMap[key].length === 0) recommendationsMap[key] = [{ name: 'é™„è¿‘ç„¡æ¨è–¦', location: item.location, note: '' }];
                        }
                    } catch (e) { console.error("æ¨è–¦æœå°‹å¤±æ•—", e); } finally { isSearchingRecs.value = false; searchTargetIndex.value = ''; }
                };
                const applyRecommendation = (item, rec) => { item.activity = rec.name; item.location = rec.name; };

                // --- Auto Detect ---
                const countryInfoMap = { 'jp': {c:'JPY',l:'ja',n:'æ—¥æ–‡'}, 'kr': {c:'KRW',l:'ko',n:'éŸ“æ–‡'}, 'us': {c:'USD',l:'en',n:'è‹±æ–‡'}, 'cn': {c:'CNY',l:'zh-CN',n:'ç°¡ä¸­'}, 'th': {c:'THB',l:'th',n:'æ³°æ–‡'} };
                const detectRate = async () => {
                    if(!setup.value.destination) return;
                    isRateLoading.value = true;
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(setup.value.destination)}&limit=1&addressdetails=1`);
                        const geoData = await geoRes.json();
                        if(geoData?.[0]?.address?.country_code) {
                            const info = countryInfoMap[geoData[0].address.country_code.toLowerCase()] || {c:'USD',l:'en',n:'è‹±æ–‡'};
                            setup.value.currency = info.c; setup.value.langCode = info.l; setup.value.langName = info.n;
                            if(info.c === 'TWD') setup.value.rate = 1;
                            else {
                                const rRes = await fetch(`https://api.exchangerate-api.com/v4/latest/${info.c}`);
                                const rData = await rRes.json();
                                if(rData?.rates?.TWD) setup.value.rate = rData.rates.TWD;
                            }
                        }
                    } catch(e) {} finally { isRateLoading.value = false; }
                };

                // --- Weather ---
                const fetchWeather = async (locName) => {
                    try {
                        weather.value.location = locName;
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locName)}&limit=1`);
                        const geoData = await geoRes.json();
                        if(geoData?.[0]) {
                            const {lat, lon} = geoData[0];
                            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&forecast_days=16`);
                            const wData = await wRes.json();
                            weather.value.temp = Math.round(wData.current_weather.temperature);
                            weather.value.icon = getWeatherIcon(wData.current_weather.weathercode);
                            if(wData.daily) weather.value.daily = wData.daily;
                        }
                    } catch(e) { weather.value.temp = '--'; }
                };

                // --- Init & Sync Logic ---
                const initTrip = async () => {
                    if(!setup.value.destination) { alert('è«‹è¼¸å…¥ç›®çš„åœ°'); return; }
                    const newDays = [];
                    const start = new Date(setup.value.startDate);
                    const dNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    for(let i=0; i<setup.value.days; i++) {
                        const curr = new Date(start); curr.setDate(start.getDate()+i);
                        const mm = curr.getMonth()+1; const dd = curr.getDate();
                        const yyyy = curr.getFullYear();
                        const fullDate = `${yyyy}-${mm < 10 ? '0'+mm : mm}-${dd < 10 ? '0'+dd : dd}`;
                        newDays.push({
                            date: `${mm < 10 ? '0'+mm : mm}/${dd < 10 ? '0'+dd : dd} (${dNames[curr.getDay()]})`,
                            shortDate: `${mm}/${dd}`,
                            fullDate: fullDate,
                            title: i===0?'æŠµé” & æ¢ç´¢':'è¡Œç¨‹è¦åŠƒ',
                            items: [], flight: null
                        });
                    }
                    if(db) {
                        try {
                            const newId = generateId();
                            await setDoc(doc(db, "trips", newId), {
                                days: newDays,
                                expenses: [],
                                tickets: [], // åˆå§‹åŒ–ç¥¨åˆ¸
                                participantsStr: 'æˆ‘, æ—…ä¼´A',
                                rate: setup.value.rate,
                                config: setup.value,
                                lastUpdate: new Date()
                            });
                            window.history.pushState({}, '', `?trip_id=${newId}`);
                            window.location.reload(); 
                        } catch(e) { alert("å»ºç«‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase è¨­å®š: " + e.message); }
                    } else { alert("Firebase æœªè¨­å®šï¼Œç„¡æ³•å»ºç«‹é›²ç«¯è¡Œç¨‹ã€‚"); }
                };

                const saveToCloud = debounce(async () => {
                    if(!db || !tripId.value || isRemoteUpdate) return;
                    syncStatus.value = 'å„²å­˜ä¸­...';
                    try {
                        await updateDoc(doc(db, "trips", tripId.value), {
                            days: days.value,
                            expenses: expenses.value,
                            tickets: tickets.value, // åŒæ­¥ç¥¨åˆ¸
                            participantsStr: participantsStr.value,
                            rate: exchangeRate.value,
                            config: setup.value,
                            lastUpdate: new Date()
                        });
                        setTimeout(() => syncStatus.value = 'å·²åŒæ­¥', 500);
                        setTimeout(() => syncStatus.value = '', 3000);
                    } catch(e) {
                        syncStatus.value = 'åŒæ­¥å¤±æ•—';
                        console.error(e);
                    }
                }, 1000);

                onMounted(async () => {
                    const params = new URLSearchParams(window.location.search);
                    const tid = params.get('trip_id');

                    if (tid && db) {
                        tripId.value = tid;
                        onSnapshot(doc(db, "trips", tid), (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                isRemoteUpdate = true;
                                days.value = data.days || [];
                                
                                // ä¿®æ­£: ç¢ºä¿èˆŠè³‡æ–™ä¹Ÿæœ‰ IDï¼Œé¿å…æ‹–æ›³å‡ºéŒ¯
                                days.value.forEach(day => {
                                    if(day.items) {
                                        day.items.forEach(item => {
                                            if(!item.id) item.id = Date.now() + Math.random();
                                            // ç¢ºä¿æœ‰ qrcode æ¬„ä½
                                            if(item.qrcode === undefined) item.qrcode = '';
                                        });
                                    }
                                });

                                expenses.value = data.expenses || [];
                                tickets.value = data.tickets || []; // è¼‰å…¥ç¥¨åˆ¸
                                participantsStr.value = data.participantsStr || 'æˆ‘, æ—…ä¼´A';
                                exchangeRate.value = data.rate || 0.215;
                                setup.value = data.config || {};
                                updateParticipants();
                                fetchWeather(setup.value.destination);
                                nextTick(() => { 
                                    isRemoteUpdate = false; 
                                    syncStatus.value = 'å·²åŒæ­¥';
                                    setTimeout(() => syncStatus.value = '', 2000);
                                    initSortable(); // è¼‰å…¥å¾Œåˆå§‹åŒ–æ‹–æ›³
                                });
                            } else {
                                alert("æ‰¾ä¸åˆ°æ­¤è¡Œç¨‹ï¼Œå¯èƒ½å·²è¢«åˆªé™¤");
                                window.history.pushState({}, '', window.location.pathname);
                                showSetupModal.value = true;
                            }
                        }, (error) => {
                            console.error(error);
                            alert("è®€å–æ¬Šé™éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Firebase Rules");
                        });
                    } else { showSetupModal.value = true; }

                    watch([days, expenses, tickets, exchangeRate, participantsStr], () => {
                        if(!isRemoteUpdate && tripId.value) saveToCloud();
                    }, { deep: true });
                });

                return {
                    viewMode, currentDayIdx, days, currentDay, participants, participantsStr, updateParticipants,
                    getGoogleMapLink, addItem, removeItem, removeCurrentDay, addDay,
                    expenses, newExpense, totalExpense, addExpense, removeExpense,
                    tickets, newTicket, addTicket, removeTicket, sortedTickets, // ç¥¨åˆ¸ç›¸é—œ
                    paidByPerson, settlementPlan, exchangeRate,
                    getTimePeriod, weather,
                    isRateLoading, updateDate, showSetupModal, setup, initTrip, weatherDisplay, detectRate, currencyLabel, currencySymbol, toggleFlightCard, getDotColor,
                    searchNearby, recommendationsMap, isSearchingRecs, applyRecommendation, searchTargetIndex,
                    copyShareLink, syncStatus, syncStatusClass, syncStatusIcon, isKoreaTrip, getNaverMapLink, getDayName,
                    adjustHeight, itineraryList
                };
            }
        }).mount('#app')
    </script>
</body>
</html>
