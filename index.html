<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—…éŠè¨ˆç•«</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* å¼·åˆ¶é–å®š Body */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            position: fixed; overflow: hidden;
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #F3F4F6;
            overscroll-behavior-y: none;
        }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* å´é‚Šæ¬„å‹•ç•« */
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
        
        /* ç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
        .sync-status { position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-size: 12px; padding: 6px 12px; border-radius: 20px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; items-center; gap: 6px; font-weight: bold; transition: all 0.3s; }
        .sync-saving { color: #f59e0b; }
        .sync-saved { color: #10b981; }
        .sync-error { color: #ef4444; }

        /* æ‹–æ›³æ¨£å¼å„ªåŒ– [v2.6] */
        .sortable-ghost { opacity: 0.4; background: #f0f9ff; border: 2px dashed #3b82f6; }
        .sortable-fallback { opacity: 1 !important; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(1.02); cursor: grabbing; }
        .sortable-chosen { background-color: #f0fdfa; }
        .drag-handle { touch-action: none; cursor: grab; -webkit-tap-highlight-color: transparent; } 
        .drag-handle:active { cursor: grabbing; }

        #app {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        input[type="time"]::-webkit-calendar-picker-indicator { display: none; }
    </style>
</head>
<body class="text-slate-700">

    <div id="app" class="max-w-md mx-auto w-full bg-white shadow-2xl relative sm:rounded-xl sm:my-4 sm:h-[95vh] sm:border-4 sm:border-slate-100 sm:relative sm:top-auto sm:left-auto sm:right-auto sm:bottom-auto">

        <div v-if="syncStatus" class="sync-status" :class="syncStatusClass">
            <i class="ph-bold" :class="syncStatusIcon"></i> {{ syncStatus }}
        </div>

        <!-- Drawer -->
        <div v-if="showDrawer" class="absolute inset-0 z-50 flex">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" @click="showDrawer = false"></div>
            <transition name="slide" appear>
                <div class="relative bg-white w-4/5 max-w-xs h-full shadow-2xl flex flex-col z-50">
                    <div class="p-5 bg-teal-600 text-white shrink-0 relative">
                        <div class="flex justify-between items-start mb-2">
                            <h2 class="text-xl font-bold flex items-center gap-2"><i class="ph-duotone ph-list"></i> é¸å–®</h2>
                            <button @click="openSettings" class="text-teal-100 hover:text-white p-1 rounded-full hover:bg-teal-500/50 transition"><i class="ph-bold ph-gear text-2xl"></i></button>
                        </div>
                        <div v-if="tripId" class="text-sm opacity-90 truncate font-mono">{{ tripId }}</div>
                        <div class="text-xs text-teal-200 mt-1 flex items-center gap-1"><i class="ph-bold ph-user"></i> {{ setup.author || 'æœªè¨­å®šä½œè€…' }}</div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
                        <div class="mb-4">
                            <h3 class="text-xs font-bold text-slate-400 mb-2 uppercase">å°‹æ‰¾è¡Œç¨‹</h3>
                            <div class="flex gap-2 mb-2">
                                <input v-model="searchQuery" placeholder="è¼¸å…¥ ID æˆ– ä½œè€…" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-teal-500 outline-none">
                                <button @click="searchTrip" class="bg-teal-600 text-white px-3 rounded-lg flex items-center justify-center shrink-0"><i v-if="isSearching" class="ph-bold ph-spinner animate-spin"></i><i v-else class="ph-bold ph-magnifying-glass"></i></button>
                            </div>
                            <div v-if="searchResults.length > 0" class="space-y-2 mb-2">
                                <div v-for="res in searchResults" :key="res.id" @click="loadFromHistory(res.id)" class="bg-white p-2 rounded-lg border border-teal-200 shadow-sm cursor-pointer hover:bg-teal-50">
                                    <div class="font-bold text-slate-700 text-xs">{{ res.destination }}</div>
                                    <div class="flex justify-between text-[10px] text-slate-400"><span>ID: {{ res.id }}</span><span>{{ res.author }}</span></div>
                                </div>
                            </div>
                            <div v-if="searchMsg" class="text-[10px] text-red-400 text-center">{{ searchMsg }}</div>
                        </div>
                        <div>
                            <h3 class="text-xs font-bold text-slate-400 mb-2 uppercase flex justify-between items-center">æ­·å²ç´€éŒ„ <button @click="clearHistory" class="text-[10px] text-red-300 hover:text-red-500">æ¸…é™¤</button></h3>
                            <div v-if="historyTrips.length === 0" class="text-center py-4 text-slate-300 text-xs">å°šç„¡ç€è¦½ç´€éŒ„</div>
                            <div v-else class="space-y-2">
                                <div v-for="h in historyTrips" :key="h.id" @click="loadFromHistory(h.id)" class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm cursor-pointer hover:border-teal-300 transition group relative" :class="{'ring-2 ring-teal-500': h.id === tripId}">
                                    <div class="font-bold text-slate-700 text-sm truncate">{{ h.destination || 'æœªå‘½åè¡Œç¨‹' }}</div>
                                    <div class="flex justify-between items-center mt-1"><div class="text-[10px] text-slate-400 font-mono">{{ h.id }}</div><div class="text-[10px] text-teal-600 bg-teal-50 px-1.5 py-0.5 rounded">{{ h.author || 'è¨ªå®¢' }}</div></div>
                                    <div v-if="h.id === tripId" class="absolute top-2 right-2 w-2 h-2 bg-teal-500 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-200 bg-white">
                        <button @click="resetToHome" class="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-sm font-bold flex items-center justify-center gap-2"><i class="ph-bold ph-house"></i> å›é¦–é  / å»ºç«‹æ–°è¡Œç¨‹</button>
                        <div class="text-[9px] text-center text-slate-300 mt-2">v2.61</div>
                    </div>
                </div>
            </transition>
        </div>

        <!-- Header -->
        <header class="bg-teal-600 text-white shrink-0 z-20 shadow-md relative transition-all duration-300">
            <div class="p-4 flex justify-between items-center">
                <div class="flex items-center gap-3 min-w-0 flex-1 mr-2">
                    <button @click="showDrawer = true" class="text-white hover:bg-teal-700 p-1.5 -ml-1.5 rounded-lg transition shrink-0"><i class="ph-bold ph-list text-2xl"></i></button>
                    <div class="overflow-hidden flex-1">
                        <h1 class="text-xl font-bold tracking-wide flex items-center gap-2 truncate">{{ setup.destination || 'æ—…éŠè¨ˆç•«' }} <i class="ph-fill ph-airplane-tilt text-sm opacity-70"></i></h1>
                    </div>
                </div>
                <div class="flex bg-teal-800/50 p-1 rounded-lg shrink-0">
                    <button @click="viewMode = 'plan'" :class="viewMode === 'plan' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-calendar-check text-lg"></i></button>
                    <button @click="viewMode = 'tickets'" :class="viewMode === 'tickets' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-ticket text-lg"></i></button>
                    <button @click="viewMode = 'money'" :class="viewMode === 'money' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-currency-dollar text-lg"></i></button>
                    <button @click="viewMode = 'translate'" :class="viewMode === 'translate' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-translate text-lg"></i></button>
                </div>
            </div>
            <div v-if="viewMode === 'plan'" class="flex overflow-x-auto hide-scroll px-2 pb-3 space-x-3 snap-x">
                <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index; viewMode = 'plan'" class="snap-center shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-xl cursor-pointer transition-all border-2" :class="currentDayIdx === index ? 'bg-white text-teal-600 border-white shadow-lg scale-105' : 'bg-teal-500/50 text-teal-100 border-transparent hover:bg-teal-500'">
                    <span class="text-[10px] font-bold opacity-90 mb-0.5">{{ day.shortDate }} ({{ getDayName(day.fullDate) }})</span>
                    <span class="text-lg font-bold leading-none">D{{ index + 1 }}</span>
                </div>
                <button @click="addDay" class="shrink-0 w-12 h-16 rounded-xl flex items-center justify-center border-2 border-teal-400 border-dashed text-teal-200 hover:text-white hover:border-white transition"><i class="ph-bold ph-plus"></i></button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll overscroll-none pb-safe">
            <transition name="fade" mode="out-in">
                <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 pb-24">
                    <div class="bg-white p-4 rounded-2xl shadow-sm mb-4 border border-slate-100 flex justify-between items-start sticky top-0 z-10">
                        <div class="flex-1 relative pt-0.5">
                            <input type="date" :value="currentDay.fullDate" @change="updateDate($event, currentDay)" class="absolute top-0 left-0 w-40 h-8 opacity-0 z-20 cursor-pointer">
                            <input v-model="currentDay.date" class="text-xl font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0 w-full relative z-10 pointer-events-none" placeholder="Day 1">
                            <input v-model="currentDay.title" class="text-sm text-slate-500 bg-transparent border-b border-dashed border-slate-300 focus:border-teal-500 focus:outline-none w-full mt-1" placeholder="è¼¸å…¥ç•¶æ—¥ä¸»é¡Œ">
                        </div>
                        <div class="flex flex-col items-end pl-2">
                            <div v-if="weatherDisplay" class="text-right">
                                <div class="flex items-center justify-end gap-1 text-indigo-600"><i :class="['ph-duotone', weatherDisplay.icon, 'text-2xl']"></i><span class="text-xl font-bold font-mono">{{ weatherDisplay.temp }}</span></div>
                                <div class="text-[10px] text-slate-400 flex items-center gap-1 justify-end mt-0.5"><i :class="weatherDisplay.isForecast ? 'ph-bold ph-calendar' : 'ph-bold ph-map-pin'"></i>{{ weatherDisplay.label }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <div v-if="currentDay.flight" class="relative bg-gradient-to-r from-blue-600 to-teal-500 rounded-2xl text-white shadow-lg overflow-hidden">
                            <div class="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-50 rounded-full z-10"></div>
                            <div class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-50 rounded-full z-10"></div>
                            <div class="p-4 relative z-0">
                                <button @click="toggleFlightCard" class="absolute top-2 right-2 text-white/50 hover:text-white hover:bg-white/20 rounded-full p-1 transition"><i class="ph-bold ph-x"></i></button>
                                <div class="flex justify-between items-center mb-1 pt-2">
                                    <div class="flex flex-col items-center w-1/3"><input v-model="currentDay.flight.startTime" type="time" class="text-xl font-bold bg-transparent border-b border-white/30 w-full text-center text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0" @click="$event.target.showPicker ? $event.target.showPicker() : null"><div class="text-[9px] opacity-60 mt-1">èµ·é£›</div><input v-model="currentDay.flight.startAirport" class="text-sm font-bold opacity-90 bg-transparent border-none text-center w-full text-teal-100 placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="TPE"></div>
                                    <div class="flex flex-col items-center justify-center w-1/3 px-1"><i class="ph-fill ph-airplane text-2xl mb-1 transform rotate-90"></i><div class="relative w-full flex items-center justify-center gap-1"><input v-model="currentDay.flight.number" class="text-[10px] font-mono tracking-widest opacity-80 bg-transparent border-none text-center w-full text-white placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="èˆªç­è™Ÿ"><button v-if="currentDay.flight.number" @click="searchFlight(currentDay.flight.number)" class="text-white/70 hover:text-white p-1 hover:bg-white/10 rounded transition"><i class="ph-bold ph-magnifying-glass text-xs"></i></button></div><div class="w-full h-0.5 bg-white/30 rounded-full mt-1"></div></div>
                                    <div class="flex flex-col items-center w-1/3"><input v-model="currentDay.flight.endTime" type="time" class="text-xl font-bold bg-transparent border-b border-white/30 w-full text-center text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0" @click="$event.target.showPicker ? $event.target.showPicker() : null"><div class="relative w-full mt-0.5"><select v-model="currentDay.flight.arrivalOffset" class="appearance-none bg-black/20 text-white text-[9px] rounded border-none w-full py-0.5 px-1 text-center focus:ring-0 cursor-pointer hover:bg-black/30"><option value="0">åŒæ—¥</option><option value="1">+1å¤©</option><option value="-1">-1å¤©</option></select></div><input v-model="currentDay.flight.endAirport" class="text-sm font-bold opacity-90 bg-transparent border-none text-center w-full text-teal-100 placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="NRT"></div>
                                </div>
                            </div>
                        </div>
                        <button v-else @click="toggleFlightCard" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 hover:border-teal-400 hover:text-teal-500 hover:bg-teal-50/50 transition flex items-center justify-center gap-2 group"><i class="ph-bold ph-airplane-tilt text-lg group-hover:scale-110 transition-transform"></i><span class="text-sm font-bold">æ–°å¢ç•¶æ—¥èˆªç­è³‡è¨Š</span></button>
                    </div>

                    <div class="relative pl-4 border-l-2 border-teal-100">
                        <div ref="itineraryList" class="space-y-6 pb-8">
                            <div v-for="(item, idx) in currentDay.items" :key="item.id" class="relative group cursor-default">
                                <div class="absolute -left-[21px] top-3 w-3 h-3 rounded-full border-2 border-white shadow-sm" :class="getDotColor(item.type)"></div>
                                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                                    <div class="flex flex-col gap-2">
                                        <div class="flex items-start gap-3">
                                            <!-- [v2.6] Drag Handle Area -->
                                            <div class="drag-handle cursor-grab text-slate-300 hover:text-teal-500 self-center -ml-1 py-3 px-1 touch-none"><i class="ph-bold ph-dots-six-vertical text-2xl"></i></div>
                                            <div class="flex flex-col items-center w-20 shrink-0 gap-2">
                                                <div class="relative flex flex-col items-center justify-center bg-slate-50 border border-slate-200 rounded-xl p-1 w-full h-16 cursor-pointer hover:bg-teal-50 hover:border-teal-200 transition group/time"><span class="text-[10px] font-medium text-slate-400 group-hover/time:text-teal-400">{{ getTimePeriod(item.time) }}</span><span class="text-xl font-bold text-slate-700 group-hover/time:text-teal-600 leading-none font-mono tracking-tight">{{ item.time || '--:--' }}</span><input v-model="item.time" type="time" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" @click="$event.target.showPicker ? $event.target.showPicker() : null"></div>
                                                <select v-model="item.type" class="text-[10px] bg-white border border-slate-200 rounded-md py-1 px-1 w-full text-center"><option value="spot">ğŸ“ æ™¯é»</option><option value="food">ğŸ´ ç¾é£Ÿ</option><option value="shop">ğŸ›ï¸ è³¼ç‰©</option><option value="transport">ğŸš‡ äº¤é€š</option><option value="flight">âœˆï¸ èˆªç­</option><option value="hotel">ğŸ¨ ä½å®¿</option></select>
                                            </div>
                                            <div class="flex-1 min-w-0 pt-1">
                                                <input v-model="item.activity" class="block w-full font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0" placeholder="è¡Œç¨‹åç¨±...">
                                                <div class="flex items-center gap-1 mt-1"><i class="ph-fill ph-map-pin text-teal-400 text-xs"></i><input v-model="item.location" class="flex-1 text-xs text-slate-500 bg-transparent border-none p-0 focus:ring-0 truncate" placeholder="è¼¸å…¥åœ°é»"></div>
                                                <div class="mt-2 relative"><div class="flex items-start gap-2 bg-slate-50 rounded-lg p-2 border border-slate-100 group-focus-within:border-teal-200 group-focus-within:bg-white transition-colors"><i class="ph-bold ph-notebook text-slate-400 text-sm mt-0.5 shrink-0"></i><textarea v-model="item.note" class="auto-resize-textarea w-full text-xs text-slate-600 bg-transparent border-none p-0 focus:ring-0 leading-relaxed resize-none placeholder-slate-400 min-h-[20px]" placeholder="å‚™è¨»..." rows="1" @input="adjustHeight($event.target)" @focus="adjustHeight($event.target)"></textarea></div></div>
                                            </div>
                                            <div class="flex flex-col gap-2 items-center">
                                                <a :href="getGoogleMapLink(item.location)" target="_blank" class="text-teal-500 hover:bg-teal-50 p-1 rounded" title="Google Map"><i class="ph-bold ph-navigation-arrow"></i></a>
                                                <a v-if="isKoreaTrip" :href="getNaverMapLink(item.location)" target="_blank" class="text-green-500 hover:bg-green-50 p-1 rounded flex flex-col items-center justify-center border border-green-100 shadow-sm w-6 h-6" title="Naver Map"><span class="font-black text-[10px] leading-none">N</span></a>
                                                <button @click="removeItem(idx)" class="text-red-300 hover:text-red-500 p-1 rounded"><i class="ph-bold ph-trash"></i></button>
                                            </div>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-slate-100 flex items-center gap-2"><div class="relative flex-1"><div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none"><i class="ph-bold ph-qr-code text-slate-400"></i></div><input v-model="item.qrcode" class="block w-full pl-8 pr-2 py-1 text-xs bg-slate-50 border border-slate-200 rounded-lg focus:ring-1 focus:ring-teal-500" placeholder="ç¥¨åˆ¸ QR é€£çµ..."></div><a v-if="item.qrcode" :href="item.qrcode" target="_blank" class="shrink-0 bg-slate-800 text-white text-xs px-3 py-1.5 rounded-lg hover:bg-slate-700 flex items-center gap-1 shadow-sm"><i class="ph-bold ph-link"></i> é–‹å•Ÿ</a></div>
                                        <div v-if="item.type === 'food'" class="p-2 bg-orange-50 rounded-lg border border-orange-100/50 mt-1">
                                            <div class="flex items-center justify-between mb-1"><p class="text-[10px] font-bold text-orange-400 flex items-center gap-1"><i class="ph-fill ph-fork-knife"></i> ç¾é£Ÿæ¨è–¦</p><button @click="searchNearby(item, idx)" class="text-[10px] text-teal-600 hover:text-teal-800 flex items-center gap-1 bg-white px-2 py-0.5 rounded border border-teal-100 shadow-sm" :disabled="!item.location"><i class="ph-bold ph-magnifying-glass"></i> æœå°‹</button></div>
                                            <div v-if="recommendationsMap[`${currentDayIdx}-${idx}`]?.length > 0" class="flex flex-wrap gap-2 mt-1"><button v-for="rec in recommendationsMap[`${currentDayIdx}-${idx}`]" :key="rec.name" @click="applyRecommendation(item, rec)" class="text-[10px] px-2 py-1.5 bg-white border border-orange-200 rounded-lg text-slate-600 hover:bg-orange-500 hover:text-white transition shadow-sm truncate max-w-[120px]">{{ rec.name }}</button></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2"><button @click="addItem" class="flex-1 flex items-center justify-center gap-2 text-teal-500 hover:text-teal-700 text-sm font-medium px-4 py-3 bg-white border border-dashed border-teal-300 rounded-xl hover:bg-teal-50 transition shadow-sm"><div class="w-2 h-2 bg-teal-300 rounded-full"></div><i class="ph-bold ph-plus"></i> æ–°å¢è¡Œç¨‹</button></div>
                    </div>
                    <div class="mt-12 pt-6 border-t border-slate-200 text-center"><button @click="removeCurrentDay" class="text-xs text-red-300 hover:text-red-500 flex items-center justify-center gap-1 mx-auto"><i class="ph-bold ph-trash"></i> åˆªé™¤é€™ä¸€å¤©</button></div>
                </div>
            </transition>
            
            <div v-if="viewMode === 'tickets'" class="p-4 pb-24 h-full flex flex-col">
                <div class="mb-4 bg-gradient-to-r from-teal-500 to-emerald-600 rounded-2xl p-6 text-white shadow-lg"><h2 class="text-xl font-bold flex items-center gap-2"><i class="ph-bold ph-ticket"></i> æˆ‘çš„ç¥¨åˆ¸å¤¾</h2></div>
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-slate-100"><div class="flex gap-2 mb-2"><input v-model="newTicket.date" type="text" placeholder="é¸æ“‡æ—¥æœŸ" class="bg-slate-50 border-none rounded-lg text-sm px-3 py-2 w-1/3 text-slate-600" onfocus="(this.type='date')" onblur="(this.value ? this.type='date' : this.type='text')"><input v-model="newTicket.name" placeholder="ç¥¨åˆ¸åç¨±" class="bg-slate-50 border-none rounded-lg text-sm px-3 py-2 flex-1 min-w-0"></div><div class="flex gap-2"><div class="relative flex-1"><div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none"><i class="ph-bold ph-link text-slate-400"></i></div><input v-model="newTicket.link" placeholder="QR Code é€£çµ..." class="w-full pl-8 pr-2 py-2 text-sm bg-slate-50 border-none rounded-lg"></div><button @click="addTicket" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold shadow-sm whitespace-nowrap">æ–°å¢</button></div></div>
                <div class="space-y-3 flex-1 overflow-y-auto hide-scroll pb-20"><div v-if="tickets.length === 0" class="text-center py-10 text-slate-300"><i class="ph-duotone ph-ticket text-4xl mb-2"></i><p class="text-sm">é‚„æ²’æœ‰ç¥¨åˆ¸ï¼Œå¿«é»æ–°å¢å§ï¼</p></div><div v-for="(ticket, idx) in sortedTickets" :key="ticket.id" class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden group"><div class="p-4 flex justify-between items-start"><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="bg-teal-50 text-teal-700 text-[10px] font-bold px-2 py-0.5 rounded border border-teal-100">{{ ticket.date || 'ç„¡æ—¥æœŸ' }}</span></div><h3 class="text-lg font-bold text-slate-800">{{ ticket.name }}</h3><a v-if="ticket.link" :href="ticket.link" target="_blank" class="text-xs text-blue-500 hover:underline mt-1 inline-block truncate max-w-[200px]"><i class="ph-bold ph-link"></i> {{ ticket.link }}</a></div><button @click="removeTicket(ticket.id)" class="text-slate-300 hover:text-red-500 p-2"><i class="ph-bold ph-trash"></i></button></div><a v-if="ticket.link" :href="ticket.link" target="_blank" class="block bg-slate-50 p-3 text-center text-slate-600 hover:bg-slate-100 border-t border-slate-100 transition"><i class="ph-bold ph-qr-code text-xl mb-1 block"></i><span class="text-xs font-bold">é–‹å•Ÿ QR Code</span></a></div></div>
            </div>

            <div v-if="viewMode === 'money'" class="p-4 pb-24">
                <div class="bg-teal-600 text-white rounded-2xl p-6 shadow-lg mb-6 text-center relative"><div class="absolute top-4 right-4 flex flex-col items-end"><label class="text-[10px] text-teal-200 mb-1">åŒ¯ç‡</label><input v-model.number="exchangeRate" type="number" step="0.001" class="w-16 text-right text-xs text-teal-900 rounded px-1 py-0.5"></div><div class="text-sm opacity-80 mb-1">ç¸½æ”¯å‡º Total</div><div class="text-4xl font-bold font-mono">{{ currencySymbol }} {{ totalExpense.toLocaleString() }}</div><div class="text-lg font-bold text-teal-200 mt-1">â‰ˆ NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}</div></div>
                <div class="mb-4 bg-white p-4 rounded-xl border border-slate-100 shadow-sm"><input v-model="participantsStr" @change="updateParticipants" class="w-full text-sm bg-slate-50 rounded px-2 py-1 border border-slate-200" placeholder="åˆ†å¸³æˆå“¡: æˆ‘, æœ‹å‹A..."></div>
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-slate-100"><div class="flex gap-2 mb-2"><input v-model="newExpense.item" placeholder="é …ç›®" class="w-[65%] bg-slate-50 border-none rounded-lg text-sm px-3 py-2"><select v-model="newExpense.payer" class="flex-1 bg-slate-50 border-none rounded-lg text-sm px-2 py-2 min-w-0"><option v-for="p in participants" :value="p">{{ p }}</option></select></div><div class="flex gap-2"><input v-model.number="newExpense.amount" type="number" :placeholder="currencySymbol + ' é‡‘é¡'" class="w-full bg-slate-50 border-none rounded-lg text-sm pl-3 pr-3 py-2 font-mono"><button @click="addExpense" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold"><i class="ph-bold ph-plus"></i></button></div></div>
                <div class="space-y-3"><div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 text-xs font-bold">{{ exp.payer.charAt(0) }}</div><div class="font-bold text-slate-700 text-sm">{{ exp.item }}</div></div><div class="flex items-center gap-3"><span class="font-mono font-bold text-slate-700">{{ currencySymbol }}{{ exp.amount.toLocaleString() }}</span><button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400"><i class="ph-fill ph-x-circle"></i></button></div></div></div>
            </div>

            <div v-if="viewMode === 'translate'" class="p-6 h-full flex flex-col justify-center items-center pb-32">
                <div class="w-full mb-4"><a href="https://translate.google.com/?op=images" target="_blank" class="block w-full"><button class="w-full bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-2xl p-6 shadow-lg"><div class="text-2xl font-bold">ç…§ç›¸ç¿»è­¯ <i class="ph-bold ph-camera"></i></div></button></a></div>
                <div class="w-full mb-4"><a :href="`https://translate.google.com/?sl=zh-TW&tl=${setup.langCode}&op=translate`" target="_blank" class="block w-full"><button class="w-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white rounded-2xl p-6 shadow-lg"><div class="text-2xl font-bold">CH <i class="ph-bold ph-arrow-right"></i> {{ setup.langCode.toUpperCase() }}</div></button></a></div>
                <div class="w-full"><a :href="`https://translate.google.com/?sl=${setup.langCode}&tl=zh-TW&op=translate`" target="_blank" class="block w-full"><button class="w-full bg-white border-2 border-slate-200 text-slate-700 rounded-2xl p-6 shadow-sm group hover:border-indigo-300"><div class="relative z-10 flex items-center justify-between"><div class="text-left"><div class="text-xs text-slate-400 mb-1 tracking-wider">å°æ–¹èªª{{ setup.langName }} (è½‰ä¸­æ–‡)</div><div class="text-2xl font-bold font-jp">{{ setup.langCode.toUpperCase() }} <i class="ph-bold ph-arrow-right text-sm"></i> CH</div></div><i class="ph-duotone ph-arrow-square-out text-3xl text-slate-300 group-hover:text-indigo-500 transition-colors"></i></div></button></a></div>
            </div>
        </main>
        
        <!-- Gatekeeper Modal -->
        <div v-if="isLocked" class="absolute inset-0 bg-slate-800 z-[100] flex flex-col items-center justify-center p-6 animate-fade-in">
            <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500"><i class="ph-bold ph-lock-key text-3xl"></i></div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">æ­¤è¡Œç¨‹å—ä¿è­·</h2>
                <p class="text-sm text-slate-500 mb-6">è«‹è¼¸å…¥æå–ç¢¼ä»¥æª¢è¦–å…§å®¹</p>
                <input v-model="unlockCodeInput" type="password" maxlength="6" class="w-full text-center text-2xl font-mono tracking-widest bg-slate-100 border border-slate-300 rounded-xl py-3 mb-4 focus:ring-2 focus:ring-red-500 outline-none placeholder:text-slate-300" placeholder="â€¢â€¢â€¢â€¢">
                <button @click="unlockTrip" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg mb-3">è§£é–è¡Œç¨‹</button>
                <button @click="resetToHome" class="text-slate-400 text-sm hover:text-slate-600">å›é¦–é </button>
            </div>
        </div>

        <!-- Initial Setup Modal -->
        <div v-if="showSetupModal" class="absolute inset-0 bg-teal-800 z-[90] flex items-center justify-center p-6 animate-fade-in overflow-y-auto">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl my-auto">
                <div class="flex p-1 bg-slate-100 rounded-xl mb-6">
                    <button @click="homeTab = 'create'" class="flex-1 py-2 rounded-lg text-sm font-bold transition" :class="homeTab === 'create' ? 'bg-white text-teal-600 shadow-sm' : 'text-slate-400'">å»ºç«‹è¡Œç¨‹</button>
                    <button @click="homeTab = 'find'" class="flex-1 py-2 rounded-lg text-sm font-bold transition" :class="homeTab === 'find' ? 'bg-white text-teal-600 shadow-sm' : 'text-slate-400'">å°‹æ‰¾è¡Œç¨‹</button>
                </div>

                <div v-if="homeTab === 'create'" class="space-y-4">
                    <div><label class="block text-xs font-bold text-slate-400 mb-1 ml-1">è‡ªè¨‚ä»£ç¢¼ ID (å¿…å¡«)</label><input v-model="setup.customId" @blur="checkIdAvailability" type="text" placeholder="ä¾‹å¦‚: tokyo2025" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 font-bold focus:ring-2 focus:ring-teal-500"><div v-if="idStatus" class="text-[10px] mt-1 ml-1 font-bold" :class="idStatus.valid ? 'text-green-500' : 'text-red-500'">{{ idStatus.msg }}</div></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1 ml-1">æå–ç¢¼ (å¯†ç¢¼)</label><input v-model="setup.extractionCode" type="text" placeholder="è¨­å®šå¯†ç¢¼ (ä¾‹: 1234)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 font-mono"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ç›®çš„åœ°</label><input v-model="setup.destination" @blur="detectRate" type="text" placeholder="Tokyo" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 font-bold"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ä½œè€…</label><input v-model="setup.author" type="text" placeholder="æ‚¨çš„æš±ç¨±" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700"></div>
                    <div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-slate-400 mb-1">æ—¥æœŸ</label><input v-model="setup.startDate" type="date" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-3 text-sm"></div><div><label class="block text-xs font-bold text-slate-400 mb-1">å¤©æ•¸</label><input v-model.number="setup.days" type="number" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-3 text-center font-bold"></div></div>
                    <button @click="initTrip" :disabled="!idStatus.valid || !setup.extractionCode" class="w-full bg-teal-600 hover:bg-teal-700 disabled:bg-slate-300 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2">é–‹å§‹è¦åŠƒ</button>
                </div>

                <div v-else class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">é›²ç«¯æå–</label>
                        <div class="flex gap-2">
                            <input v-model="searchQuery" placeholder="è¼¸å…¥ ID æˆ– ä½œè€…åç¨±" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700">
                            <button @click="searchTrip" class="bg-teal-600 text-white px-4 rounded-xl flex items-center"><i v-if="isSearching" class="ph-bold ph-spinner animate-spin"></i><i v-else class="ph-bold ph-magnifying-glass"></i></button>
                        </div>
                        <div v-if="searchResults.length > 0" class="mt-2 space-y-2 max-h-[150px] overflow-y-auto">
                            <div v-for="res in searchResults" :key="res.id" @click="loadFromHistory(res.id)" class="bg-teal-50 p-2 rounded-lg border border-teal-200 cursor-pointer">
                                <div class="font-bold text-teal-800 text-sm">{{ res.destination }}</div>
                                <div class="flex justify-between text-[10px] text-teal-600"><span>ID: {{ res.id }}</span><span>{{ res.author }}</span></div>
                            </div>
                        </div>
                        <div v-if="searchMsg" class="text-xs text-red-400 mt-1 ml-1">{{ searchMsg }}</div>
                    </div>
                    <div class="pt-4 border-t border-slate-100">
                        <div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-slate-400">æœ¬æ©Ÿæ­·å²ç´€éŒ„</label><button @click="clearHistory" class="text-[10px] text-red-300">æ¸…é™¤</button></div>
                        <div v-if="historyTrips.length === 0" class="text-center py-8 text-slate-300 text-xs">ç„¡ç´€éŒ„</div>
                        <div v-else class="max-h-[200px] overflow-y-auto space-y-2 pr-1">
                            <div v-for="h in historyTrips" :key="h.id" @click="loadFromHistory(h.id)" class="bg-slate-50 p-3 rounded-xl border border-slate-100 cursor-pointer hover:bg-teal-50 hover:border-teal-200 transition">
                                <div class="font-bold text-slate-700 text-sm">{{ h.destination || 'è¡Œç¨‹' }}</div>
                                <div class="flex justify-between text-[10px] text-slate-400 mt-1"><span>{{ h.id }}</span><span>{{ h.author }}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div v-if="showSettingsModal" class="absolute inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-6 animate-fade-in" @click.self="showSettingsModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto hide-scroll">
                <button @click="showSettingsModal = false" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-xl"></i></button>
                <div class="text-center mb-6"><div class="w-12 h-12 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-2"><i class="ph-bold ph-gear text-xl text-teal-600"></i></div><h2 class="text-lg font-bold text-slate-800">è¡Œç¨‹è¨­å®š</h2></div>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">ä½œè€…æš±ç¨±</label><input v-model="setup.author" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1 ml-1 flex justify-between"><span>æå–ç¢¼ (å¯†ç¢¼)</span><span v-if="!setup.extractionCode" class="text-red-500 animate-pulse">âš ï¸ æœªè¨­å®šä¿è­·</span></label><input v-model="setup.extractionCode" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm font-mono text-teal-600 font-bold"><p class="text-[10px] text-slate-400 mt-1 ml-1">ä¿®æ”¹å¾Œè«‹å‹™å¿…è¨˜ä½æ–°ä»£ç¢¼ã€‚</p></div>
                    
                    <div class="border-t border-slate-100 pt-4 mt-2">
                        <label class="block text-xs font-bold text-indigo-500 mb-1 ml-1 flex items-center gap-1"><i class="ph-bold ph-swap"></i> è®Šæ›´è¡Œç¨‹ ID (æ¬å®¶)</label>
                        <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                            <div class="text-[10px] text-indigo-400 mb-2">ç›®å‰ ID: <span class="font-mono text-indigo-600">{{ tripId }}</span></div>
                            <input v-model="newMigrateId" placeholder="è¼¸å…¥æ–° ID (ä¾‹å¦‚: mytrip2025)" class="w-full bg-white border border-indigo-200 rounded-lg px-3 py-2 text-sm mb-2 focus:ring-2 focus:ring-indigo-500">
                            <button @click="migrateTripId" :disabled="isMigrating" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-bold py-2 rounded-lg shadow-sm flex items-center justify-center gap-1">
                                <i v-if="isMigrating" class="ph-bold ph-spinner animate-spin"></i>
                                <span v-else>ç¢ºèªè®Šæ›´ ID</span>
                            </button>
                            <p class="text-[9px] text-red-400 mt-2 font-bold leading-tight">âš ï¸ è­¦å‘Šï¼šè®Šæ›´å¾Œï¼ŒèˆŠçš„åˆ†äº«é€£çµå°‡ç«‹å³å¤±æ•ˆï¼è«‹é‡æ–°åˆ†äº«æ–°ç¶²å€çµ¦æ—…ä¼´ã€‚</p>
                        </div>
                    </div>

                    <button @click="saveSettings" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl shadow-lg mt-2">å„²å­˜ä¸€èˆ¬è¨­å®š</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc, deleteDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBHBeNkqkVoRl4E7FAcEPI-c2M-0ffSFPM",
            authDomain: "mytravelapp-f9c1c.firebaseapp.com",
            projectId: "mytravelapp-f9c1c",
            storageBucket: "mytravelapp-f9c1c.firebasestorage.app",
            messagingSenderId: "1024870317388",
            appId: "1:1024870317388:web:772e1a90d888ab2107a3e9"
        };

        let appInstance, db;
        try {
            appInstance = initializeApp(firebaseConfig);
            db = getFirestore(appInstance);
        } catch(e) { console.error(e); }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const app = createApp({
            setup() {
                // UI States
                const viewMode = ref('plan');
                const homeTab = ref('create'); 
                const currentDayIdx = ref(0);
                const showSetupModal = ref(false);
                const showDrawer = ref(false);
                const showSettingsModal = ref(false);
                const itineraryList = ref(null);
                
                // Security & Data
                const tripId = ref(null);
                const isLocked = ref(false);
                const unlockCodeInput = ref('');
                const dbData = ref(null);
                const historyTrips = ref([]);
                const lastSavedState = ref('');
                const lastServerStr = ref(''); // [v2.6] Server State Lock
                let syncTimeout = null;
                
                // Search & Migration
                const searchQuery = ref('');
                const searchResults = ref([]);
                const isSearching = ref(false);
                const searchMsg = ref('');
                const idStatus = ref({ valid: false, msg: '' });
                const newMigrateId = ref('');
                const isMigrating = ref(false);

                // Trip Data
                const days = ref([]);
                const expenses = ref([]);
                const tickets = ref([]);
                const newTicket = ref({ date: '', name: '', link: '' });
                const participants = ref(['æˆ‘', 'æ—…ä¼´A']);
                const participantsStr = ref('æˆ‘, æ—…ä¼´A');
                const exchangeRate = ref(0.215);
                const newExpense = ref({ item: '', amount: '', payer: 'æˆ‘' });
                const setup = ref({ 
                    destination: 'Tokyo', startDate: new Date().toISOString().split('T')[0], days: 5, 
                    rate: 0.215, currency: 'JPY', langCode: 'ja', langName: 'æ—¥æ–‡',
                    customId: '', extractionCode: '', author: '' 
                });
                
                const isRateLoading = ref(false);
                const weather = ref({ temp: null, icon: 'ph-sun', daily: [] });
                const syncStatus = ref('');
                let isRemoteUpdate = false;
                const recommendationsMap = reactive({});
                const isSearchingRecs = ref(false);
                const searchTargetIndex = ref('');
                let sortableInstance = null;

                // --- Computed ---
                const currentDay = computed(() => days.value[currentDayIdx.value] || {items:[], flight:null, date:'', title:''});
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const sortedTickets = computed(() => [...tickets.value].sort((a, b) => (a.date && b.date) ? new Date(a.date) - new Date(b.date) : 0));
                const paidByPerson = computed(() => {
                    const map = {}; participants.value.forEach(p => map[p] = 0);
                    expenses.value.forEach(e => { if (map[e.payer] === undefined) map[e.payer] = 0; map[e.payer] += e.amount; });
                    return map;
                });
                const settlementPlan = computed(() => {
                    if (totalExpense.value === 0) return [];
                    const avg = totalExpense.value / participants.value.length;
                    let balances = participants.value.map(p => ({ name: p, val: (paidByPerson.value[p] || 0) - avg }));
                    let debtors = balances.filter(b => b.val < -1).sort((a, b) => a.val - b.val);
                    let creditors = balances.filter(b => b.val > 1).sort((a, b) => b.val - a.val);
                    const res = []; let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let amount = Math.min(Math.abs(debtors[i].val), creditors[j].val);
                        if (Math.round(amount) > 0) res.push({ from: debtors[i].name, to: creditors[j].name, amount: Math.round(amount) });
                        debtors[i].val += amount; creditors[j].val -= amount;
                        if (Math.abs(debtors[i].val) < 1) i++; if (creditors[j].val < 1) j++;
                    }
                    return res;
                });
                const currencyLabel = computed(() => setup.value.currency || 'å¤–å¹£');
                const currencySymbol = computed(() => ({ 'JPY':'Â¥', 'CNY':'Â¥', 'USD':'$', 'EUR':'â‚¬', 'KRW':'â‚©', 'TWD':'NT$' }[setup.value.currency] || '$'));
                
                const weatherDisplay = computed(() => {
                    // [v2.56 Fix] 0 degree check
                    const hasCurrentTemp = weather.value.temp !== null && weather.value.temp !== undefined;
                    const currentTempDisplay = hasCurrentTemp ? weather.value.temp : '--';
                    const fallback = { temp: currentTempDisplay, icon: weather.value.icon || 'ph-sun', label: 'ç›®å‰', isForecast: false };
                    
                    if (!currentDay.value.fullDate || !weather.value.daily || !weather.value.daily.time || weather.value.daily.time.length === 0) {
                        return fallback;
                    }

                    const idx = weather.value.daily.time.indexOf(currentDay.value.fullDate);
                    
                    if (idx !== -1) {
                        if (weather.value.daily.temperature_2m_min && weather.value.daily.temperature_2m_min[idx] !== undefined &&
                            weather.value.daily.temperature_2m_max && weather.value.daily.temperature_2m_max[idx] !== undefined) {
                            return { 
                                temp: `${Math.round(weather.value.daily.temperature_2m_min[idx])}Â°-${Math.round(weather.value.daily.temperature_2m_max[idx])}Â°`, 
                                icon: getWeatherIcon(weather.value.daily.weathercode ? weather.value.daily.weathercode[idx] : 0), 
                                label: 'é å ±', 
                                isForecast: true 
                            };
                        }
                    }
                    return fallback;
                });

                const syncStatusClass = computed(() => ({ 'å„²å­˜ä¸­...': 'sync-saving', 'å·²åŒæ­¥': 'sync-saved' }[syncStatus.value] || 'sync-error'));
                const syncStatusIcon = computed(() => ({ 'å„²å­˜ä¸­...': 'ph-spinner animate-spin', 'å·²åŒæ­¥': 'ph-check-circle' }[syncStatus.value] || 'ph-warning'));
                const isKoreaTrip = computed(() => setup.value.langCode === 'ko' || setup.value.currency === 'KRW');

                // --- History Logic ---
                const loadHistory = () => {
                    try {
                        const h = localStorage.getItem('trip_history_v2');
                        if (h) historyTrips.value = JSON.parse(h);
                    } catch(e) {}
                };
                const addToHistory = (id, dest, auth) => {
                    const newEntry = { id, destination: dest || 'æœªå‘½å', author: auth || 'è¨ªå®¢', timestamp: Date.now() };
                    historyTrips.value = [newEntry, ...historyTrips.value.filter(h => h.id !== id)].slice(0, 10);
                    localStorage.setItem('trip_history_v2', JSON.stringify(historyTrips.value));
                };
                const clearHistory = () => { historyTrips.value = []; localStorage.removeItem('trip_history_v2'); };

                // --- Core Logic ---
                const getLocalDateString = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${dd}`;
                };

                const checkIdAvailability = async () => {
                    if (!setup.value.customId) { idStatus.value = {valid:false, msg:''}; return; }
                    const id = setup.value.customId.trim();
                    if (id.length < 3) { idStatus.value = {valid:false, msg:'ID è‡³å°‘3å€‹å­—å…ƒ'}; return; }
                    try {
                        const snap = await getDoc(doc(db, "trips", id));
                        if (snap.exists()) idStatus.value = {valid:false, msg:'æ­¤ ID å·²è¢«ä½¿ç”¨'};
                        else idStatus.value = {valid:true, msg:'æ­¤ ID å¯ç”¨'};
                    } catch(e) { idStatus.value = {valid:false, msg:'æª¢æŸ¥å¤±æ•—'}; }
                };

                const initTrip = async () => {
                    if (!idStatus.value.valid) return alert("è«‹ç¢ºèª ID å¯ç”¨");
                    if (!setup.value.extractionCode) return alert("è«‹è¨­å®šæå–ç¢¼");
                    
                    const newDays = [];
                    const [y, m, d] = setup.value.startDate.split('-').map(Number);
                    const start = new Date(y, m - 1, d); 

                    for(let i=0; i<setup.value.days; i++) {
                        const curr = new Date(start); 
                        curr.setDate(start.getDate()+i);
                        const iso = getLocalDateString(curr);
                        newDays.push({ 
                            date: `${curr.getMonth()+1}/${curr.getDate()}`, 
                            shortDate: `${curr.getMonth()+1}/${curr.getDate()}`, 
                            fullDate: iso, 
                            title: i===0?'æŠµé”':'è¡Œç¨‹', 
                            items: [] 
                        });
                    }
                    try {
                        const newId = setup.value.customId.trim();
                        const initialData = {
                            days: newDays, expenses: [], tickets: [], participantsStr: 'æˆ‘, æ—…ä¼´A', rate: setup.value.rate,
                            config: setup.value, author: setup.value.author, extractionCode: setup.value.extractionCode, lastUpdate: new Date()
                        };
                        await setDoc(doc(db, "trips", newId), initialData);
                        lastSavedState.value = JSON.stringify(initialData); 
                        addToHistory(newId, setup.value.destination, setup.value.author);
                        window.location.href = `?trip_id=${newId}`;
                    } catch(e) { alert("å»ºç«‹å¤±æ•—: " + e.message); }
                };

                const loadTripData = (data) => {
                    isRemoteUpdate = true;
                    // [v2.56 Revert] No weather loading from DB
                    const { lastUpdate, ...rest } = data;
                    const contentStr = JSON.stringify(rest);
                    lastSavedState.value = contentStr;
                    lastServerStr.value = contentStr; // [v2.6] Lock server state
                    
                    days.value = data.days || [];
                    days.value.forEach(d => d.items?.forEach(i => { if(!i.id) i.id = Math.random(); if(i.qrcode===undefined) i.qrcode=''; }));
                    expenses.value = data.expenses || [];
                    tickets.value = data.tickets || [];
                    participantsStr.value = data.participantsStr || 'æˆ‘, æ—…ä¼´A';
                    exchangeRate.value = data.rate || 0.215;
                    setup.value = data.config || {};
                    setup.value.author = data.author || setup.value.author || '';
                    setup.value.extractionCode = data.extractionCode || '';
                    
                    updateParticipants();
                    
                    nextTick(() => {
                        if(setup.value.destination) fetchWeather(setup.value.destination);
                        isRemoteUpdate = false; 
                        syncStatus.value = 'å·²åŒæ­¥'; 
                        if(syncTimeout) clearTimeout(syncTimeout); 
                        syncTimeout = setTimeout(() => syncStatus.value = '', 2000); 
                        initSortable(); 
                    });
                };

                const unlockTrip = () => {
                    if (unlockCodeInput.value === dbData.value.extractionCode) {
                        isLocked.value = false;
                        loadTripData(dbData.value);
                        addToHistory(tripId.value, dbData.value.config?.destination, dbData.value.author);
                    } else { alert("æå–ç¢¼éŒ¯èª¤"); }
                };

                const startListening = (tid) => {
                    tripId.value = tid;
                    onSnapshot(doc(db, "trips", tid), (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.extractionCode && !isLocked.value && !dbData.value) { dbData.value = data; isLocked.value = true; } 
                            else if (data.extractionCode && isLocked.value) { dbData.value = data; } 
                            else { loadTripData(data); if(!isLocked.value) addToHistory(tid, data.config?.destination, data.author); }
                        } else { alert("æ‰¾ä¸åˆ°æ­¤è¡Œç¨‹"); window.history.pushState({}, '', window.location.pathname); showSetupModal.value = true; }
                    }, (err) => { console.error(err); alert("è®€å–éŒ¯èª¤"); });
                };

                const loadFromHistory = (id) => {
                    showSetupModal.value = false; showDrawer.value = false; isLocked.value = false; dbData.value = null; unlockCodeInput.value = '';
                    window.history.pushState({}, '', `?trip_id=${id}`);
                    startListening(id);
                };

                const searchTrip = async () => {
                    if(!searchQuery.value) return;
                    isSearching.value = true; searchResults.value = []; searchMsg.value = '';
                    const q = searchQuery.value.trim();
                    try {
                        const idSnap = await getDoc(doc(db, "trips", q));
                        if(idSnap.exists()) {
                            const d = idSnap.data();
                            searchResults.value.push({ id: idSnap.id, destination: d.config?.destination || 'è¡Œç¨‹', author: d.author || 'æœªçŸ¥' });
                        }
                        const authorQ = query(collection(db, "trips"), where("author", "==", q));
                        const authorSnaps = await getDocs(authorQ);
                        authorSnaps.forEach(doc => {
                            if(doc.id !== q) {
                                const d = doc.data();
                                searchResults.value.push({ id: doc.id, destination: d.config?.destination || 'è¡Œç¨‹', author: d.author });
                            }
                        });
                        if(searchResults.value.length === 0) searchMsg.value = 'æ‰¾ä¸åˆ°ç›¸ç¬¦çš„ ID æˆ–ä½œè€…';
                    } catch(e) { console.error(e); searchMsg.value = 'æœå°‹ç™¼ç”ŸéŒ¯èª¤ (è«‹æª¢æŸ¥ç¶²è·¯)'; }
                    finally { isSearching.value = false; }
                };

                const migrateTripId = async () => {
                    const newId = newMigrateId.value.trim();
                    if(!newId || newId.length < 3) return alert("æ–° ID éœ€è‡³å°‘ 3 å€‹å­—å…ƒ");
                    if(!confirm(`ç¢ºå®šè¦å°‡ ID è®Šæ›´ç‚º "${newId}" å—ï¼Ÿ\nèˆŠé€£çµå°‡ç«‹å³å¤±æ•ˆï¼`)) return;
                    isMigrating.value = true;
                    try {
                        const check = await getDoc(doc(db, "trips", newId));
                        if(check.exists()) throw new Error("æ­¤ ID å·²è¢«ä½¿ç”¨ï¼Œè«‹æ›ä¸€å€‹");
                        const currentData = {
                            days: days.value, expenses: expenses.value, tickets: tickets.value, participantsStr: participantsStr.value,
                            rate: exchangeRate.value, config: setup.value, author: setup.value.author, extractionCode: setup.value.extractionCode, lastUpdate: new Date()
                        };
                        await setDoc(doc(db, "trips", newId), currentData);
                        await deleteDoc(doc(db, "trips", tripId.value));
                        alert("è®Šæ›´æˆåŠŸï¼ç¶²é å°‡é‡æ–°è¼‰å…¥ã€‚");
                        window.location.href = `?trip_id=${newId}`;
                    } catch(e) { alert("è®Šæ›´å¤±æ•—: " + e.message); isMigrating.value = false; }
                };

                const resetToHome = () => { window.history.pushState({}, '', window.location.pathname); window.location.reload(); };
                const openSettings = () => { showDrawer.value = false; showSettingsModal.value = true; };
                const saveSettings = () => { if(tripId.value && !isRemoteUpdate) { saveToCloud(); showSettingsModal.value = false; alert("è¨­å®šå·²å„²å­˜"); } };

                const getNaverMapLink = (l) => l ? `https://map.naver.com/p/search/${encodeURIComponent(l)}` : '#';

                const fetchWeather = async (loc) => {
                    try {
                        const d = await (await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc)}&limit=1`)).json();
                        if(d?.[0]) {
                            const w = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${d[0].lat}&longitude=${d[0].lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&forecast_days=14`)).json();
                            if (w.current_weather && w.current_weather.temperature !== undefined) {
                                weather.value.temp = Math.round(w.current_weather.temperature);
                                weather.value.icon = getWeatherIcon(w.current_weather.weathercode);
                            }
                            if(w.daily) weather.value.daily = w.daily;
                        }
                    } catch(e) { console.error("Weather fetch failed", e); }
                };
                
                // [v2.61 Fixed] Restored missing Operations
                const addItem = () => currentDay.value.items.push({ id: Math.random(), time: '', type: 'spot', activity: '', location: '', note: '', qrcode: '' });
                const removeItem = (idx) => currentDay.value.items.splice(idx, 1);
                const addDay = () => days.value.push({ date: `D${days.value.length+1}`, title: '', items: [] });
                const removeCurrentDay = () => { if(days.value.length>1 && confirm('åˆªé™¤?')) days.value.splice(currentDayIdx.value, 1); };
                const getGoogleMapLink = (l) => l ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l)}` : '#';
                const addExpense = () => { if(newExpense.value.item) { expenses.value.unshift({...newExpense.value}); newExpense.value.item=''; newExpense.value.amount=''; }};
                const removeExpense = (idx) => expenses.value.splice(idx, 1);
                const addTicket = () => { if(newTicket.value.name) { tickets.value.push({id:Date.now(), ...newTicket.value}); newTicket.value={date:'',name:'',link:''}; }};
                const removeTicket = (id) => { const idx=tickets.value.findIndex(t=>t.id===id); if(idx!==-1 && confirm('åˆªé™¤?')) tickets.value.splice(idx,1); };
                const copyShareLink = () => { navigator.clipboard.writeText(window.location.href).then(()=>alert('é€£çµå·²è¤‡è£½')); };
                const searchFlight = (flightNo) => { if(!flightNo) return; window.open(`https://www.google.com/search?q=èˆªç­+${encodeURIComponent(flightNo)}`, '_blank'); };
                const searchNearby = async (item, idx) => {
                    if(!item.location) return;
                    searchTargetIndex.value = `${currentDayIdx.value}-${idx}`; isSearchingRecs.value = true;
                    try {
                        const g = await (await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}&limit=1`)).json();
                        if(g?.[0]) {
                            const r = await (await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=restaurant near ${item.location}&limit=4`)).json();
                            recommendationsMap[`${currentDayIdx.value}-${idx}`] = r.map(p=>({name: p.name || p.display_name.split(',')[0], location: p.name}));
                        }
                    } catch(e){} finally { isSearchingRecs.value = false; }
                };
                const applyRecommendation = (item, rec) => { item.activity = rec.name; item.location = rec.name; };
                const detectRate = async () => {
                    if(!setup.value.destination) return;
                    isRateLoading.value = true;
                    try {
                        const d = await (await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(setup.value.destination)}&limit=1&addressdetails=1`)).json();
                        if(d?.[0]?.address?.country_code) {
                            const map = { 'jp':{c:'JPY',l:'ja'}, 'kr':{c:'KRW',l:'ko'}, 'us':{c:'USD',l:'en'}, 'cn':{c:'CNY',l:'zh-CN'}, 'th':{c:'THB',l:'th'} };
                            const info = map[d[0].address.country_code.toLowerCase()] || {c:'USD',l:'en'};
                            setup.value.currency=info.c; setup.value.langCode=info.l;
                            if(info.c !== 'TWD') {
                                const r = await (await fetch(`https://api.exchangerate-api.com/v4/latest/${info.c}`)).json();
                                if(r?.rates?.TWD) setup.value.rate = r.rates.TWD;
                            }
                        }
                        // [v2.53 Fix] Trigger weather update on location change
                        fetchWeather(setup.value.destination);
                    } catch(e){} finally { isRateLoading.value = false; }
                };

                const saveToCloud = debounce(async () => {
                    if(!db || !tripId.value || isRemoteUpdate || isLocked.value) return;
                    
                    const dataToCompare = {
                        days: days.value, expenses: expenses.value, tickets: tickets.value, participantsStr: participantsStr.value,
                        rate: exchangeRate.value, config: setup.value, author: setup.value.author, extractionCode: setup.value.extractionCode
                    };
                    const currentJson = JSON.stringify(dataToCompare);
                    
                    // [v2.6] Double Lock: If current data is same as what we just received from server, DO NOT SAVE.
                    // This prevents the "Echo Write" bug where mobile scrolling triggers a save of old data.
                    if (currentJson === lastSavedState.value || currentJson === lastServerStr.value) return;

                    syncStatus.value = 'å„²å­˜ä¸­...';
                    try {
                        const dataToSave = { ...dataToCompare, lastUpdate: new Date() };
                        await updateDoc(doc(db, "trips", tripId.value), dataToSave);
                        lastSavedState.value = currentJson; 
                        
                        syncStatus.value = 'å·²åŒæ­¥';
                        if(syncTimeout) clearTimeout(syncTimeout);
                        syncTimeout = setTimeout(() => syncStatus.value = '', 3000);
                    } catch(e) { syncStatus.value = 'åŒæ­¥å¤±æ•—'; console.error(e); }
                }, 1000);

                onMounted(() => {
                    loadHistory();
                    const params = new URLSearchParams(window.location.search);
                    const tid = params.get('trip_id');
                    if (tid && db) { showSetupModal.value = false; startListening(tid); } 
                    else { showSetupModal.value = true; }
                    
                    watch([days, expenses, tickets, exchangeRate, participantsStr], () => saveToCloud(), { deep: true });
                });

                watch([viewMode, currentDayIdx], async () => { if (viewMode.value === 'plan') { await nextTick(); initSortable(); }});

                // Common Helpers
                const getWeatherIcon = (c) => { if (c===0) return 'ph-sun'; if (c<4) return 'ph-cloud-sun'; if (c<50) return 'ph-cloud-fog'; if (c<70) return 'ph-cloud-rain'; return 'ph-cloud'; };
                const getTimePeriod = (t) => { if(!t) return 'æ™‚é–“'; const h=parseInt(t.split(':')[0]); return h<5?'å‡Œæ™¨':h<11?'ä¸Šåˆ':h<14?'ä¸­åˆ':h<18?'ä¸‹åˆ':'æ™šä¸Š'; };
                const toggleFlightCard = () => { if (currentDay.value.flight) { if(confirm('ç§»é™¤èˆªç­?')) currentDay.value.flight = null; } else { currentDay.value.flight = { type: 'arrival', startTime: '10:00', startAirport: 'TPE', number: 'FLIGHT', endTime: '14:00', endAirport: 'DEST', arrivalOffset: 0 }; } };
                const getDotColor = (t) => t==='food'?'bg-orange-400':t==='shop'?'bg-pink-400':t==='flight'?'bg-blue-500':t==='hotel'?'bg-indigo-500':'bg-teal-500';
                const updateParticipants = () => { participants.value = participantsStr.value.split(',').map(s=>s.trim()).filter(s=>s); };
                const updateDate = (e, day) => { const v=e.target.value; if(!v)return; day.fullDate=v; const d=new Date(v); const m=d.getMonth()+1, dd=d.getDate(); day.date=`${m<10?'0'+m:m}/${dd<10?'0'+dd:dd}`; day.shortDate=`${m}/${dd}`; };
                const getDayName = (str) => { if(!str) return ''; const [y, m, d] = str.split('-').map(Number); return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(y, m-1, d).getDay()]; };
                const adjustHeight = (el) => { if(el){ el.style.height='auto'; el.style.height=(el.scrollHeight)+'px'; } };
                
                // [v2.6] SortableJS Optimized Configuration
                const initSortable = () => {
                    if (sortableInstance) sortableInstance.destroy();
                    if (!itineraryList.value) return;
                    sortableInstance = new Sortable(itineraryList.value, {
                        group: 'shared', 
                        animation: 200, 
                        handle: '.drag-handle', 
                        ghostClass: 'sortable-ghost', 
                        fallbackClass: 'sortable-fallback', 
                        chosenClass: 'sortable-chosen',
                        forceFallback: true, 
                        fallbackTolerance: 3, 
                        scroll: true, 
                        scrollSensitivity: 80, 
                        scrollSpeed: 10,
                        delay: 150, // [Mobile] Press delay to prevent scroll conflict
                        delayOnTouchOnly: true, // [Desktop] Instant drag
                        touchStartThreshold: 5, // [Mobile] Require movement to start drag
                        onEnd: (evt) => { 
                            const item = currentDay.value.items.splice(evt.oldIndex, 1)[0]; 
                            currentDay.value.items.splice(evt.newIndex, 0, item); 
                        }
                    });
                };

                return {
                    viewMode, currentDayIdx, days, currentDay, participants, participantsStr, updateParticipants,
                    getGoogleMapLink, addItem, removeItem, removeCurrentDay, addDay,
                    expenses, newExpense, totalExpense, addExpense, removeExpense,
                    tickets, newTicket, addTicket, removeTicket, sortedTickets,
                    paidByPerson, settlementPlan, exchangeRate, currencyLabel, currencySymbol,
                    getTimePeriod, weather, weatherDisplay,
                    isRateLoading, updateDate, showSetupModal, setup, initTrip, detectRate, toggleFlightCard, getDotColor,
                    searchNearby, recommendationsMap, isSearchingRecs, applyRecommendation, searchTargetIndex,
                    copyShareLink, syncStatus, syncStatusClass, syncStatusIcon, getNaverMapLink, getDayName, adjustHeight, itineraryList,
                    homeTab, checkIdAvailability, idStatus, searchQuery, searchResults, isSearching, searchMsg, searchTrip,
                    isLocked, unlockTrip, unlockCodeInput, showDrawer, historyTrips, loadFromHistory, clearHistory, resetToHome,
                    showSettingsModal, openSettings, saveSettings, tripId,
                    newMigrateId, isMigrating, migrateTripId,
                    searchFlight, isKoreaTrip
                };
            }
        }).mount('#app')
    </script>
</body>
</html>
